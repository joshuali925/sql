<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>SQL Aggregate Window Functions &#8212; sql-docs  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="sql-aggregate-window-functions">
<h1>SQL Aggregate Window Functions<a class="headerlink" href="#sql-aggregate-window-functions" title="Link to this heading">¶</a></h1>
<section id="overview">
<h2>1.Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>To support aggregate window functions, the following two problems need to be addressed:</p>
<ol class="arabic simple">
<li><p>How to make existing aggregate functions work as window function</p></li>
<li><p>How to handle duplicate sort key (field values in ORDER BY, will elaborate shortly)</p></li>
</ol>
<p>For the first problem, a wrapper class AggregateWindowFunction is created. In particular, it extends Expression interface and reuse existing aggregate functions to calculate result based on window frame. <strong>Now let’s examine in details how to address the second problem</strong>.</p>
</section>
<section id="problem-statement">
<h2>2.Problem Statement<a class="headerlink" href="#problem-statement" title="Link to this heading">¶</a></h2>
<p>First let’s check why it’s a problem to the window frame and ranking window function framework introduced earlier. In the following example, <code class="docutils literal notranslate"><span class="pre">age</span></code> as sort key in <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">age</span></code> is unique, so the running total is accumulated on each row incrementally.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">SELECT</span>
    <span class="o">-&gt;</span>  <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">()</span> <span class="n">AS</span> <span class="s2">&quot;no.&quot;</span><span class="p">,</span>
    <span class="o">-&gt;</span>  <span class="n">state</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">balance</span><span class="p">,</span>
    <span class="o">-&gt;</span>  <span class="n">SUM</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">BY</span> <span class="n">state</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">age</span><span class="p">)</span> <span class="n">AS</span> <span class="s2">&quot;running total&quot;</span>
    <span class="o">-&gt;</span> <span class="n">FROM</span> <span class="n">accounts</span>
    <span class="o">-&gt;</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">state</span> <span class="n">DESC</span><span class="p">,</span> <span class="n">age</span><span class="p">;</span>
<span class="o">+-----+-------+------+---------+---------------+</span>
<span class="o">|</span> <span class="n">no</span><span class="o">.</span> <span class="o">|</span> <span class="n">state</span> <span class="o">|</span> <span class="n">age</span>  <span class="o">|</span> <span class="n">balance</span> <span class="o">|</span> <span class="n">running</span> <span class="n">total</span> <span class="o">|</span>
<span class="o">+-----+-------+------+---------+---------------+</span>
<span class="o">|</span>   <span class="mi">1</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">10</span> <span class="o">|</span>     <span class="mi">100</span> <span class="o">|</span>           <span class="mi">100</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">2</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">20</span> <span class="o">|</span>     <span class="mi">200</span> <span class="o">|</span>           <span class="mi">300</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">3</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">25</span> <span class="o">|</span>      <span class="mi">50</span> <span class="o">|</span>           <span class="mi">350</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">4</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">35</span> <span class="o">|</span>     <span class="mi">150</span> <span class="o">|</span>           <span class="mi">500</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">5</span> <span class="o">|</span> <span class="n">CA</span>    <span class="o">|</span>   <span class="mi">18</span> <span class="o">|</span>     <span class="mi">150</span> <span class="o">|</span>           <span class="mi">150</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">6</span> <span class="o">|</span> <span class="n">CA</span>    <span class="o">|</span>   <span class="mi">25</span> <span class="o">|</span>     <span class="mi">100</span> <span class="o">|</span>           <span class="mi">250</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">7</span> <span class="o">|</span> <span class="n">CA</span>    <span class="o">|</span>   <span class="mi">30</span> <span class="o">|</span>     <span class="mi">200</span> <span class="o">|</span>           <span class="mi">450</span> <span class="o">|</span>
<span class="o">+-----+-------+------+---------+---------------+</span>
</pre></div>
</div>
<p>However, problem arises when the sort key has duplicate values. For example, the 2nd and 3rd row (called peers) in ‘WA’ partition has same value. Same for the 5th and 6th row in the ‘CA’ partition. In this case, the running total would be the same for peer rows. This looks strange at first sight, though the reason is <strong>the fact that which row is current is defined by sort key. That’s why the existing window frame and function implementation only based on and access to current row won’t work.</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">SELECT</span>
    <span class="o">-&gt;</span>  <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">()</span> <span class="n">AS</span> <span class="s2">&quot;no.&quot;</span><span class="p">,</span>
    <span class="o">-&gt;</span>  <span class="n">state</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">balance</span><span class="p">,</span>
    <span class="o">-&gt;</span>  <span class="n">SUM</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">BY</span> <span class="n">state</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">age</span><span class="p">)</span> <span class="n">AS</span> <span class="s2">&quot;running total&quot;</span>
    <span class="o">-&gt;</span> <span class="n">FROM</span> <span class="n">accounts</span>
    <span class="o">-&gt;</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">state</span> <span class="n">DESC</span><span class="p">,</span> <span class="n">age</span><span class="p">;</span>
<span class="o">+-----+-------+------+---------+---------------+</span>
<span class="o">|</span> <span class="n">no</span><span class="o">.</span> <span class="o">|</span> <span class="n">state</span> <span class="o">|</span> <span class="n">age</span>  <span class="o">|</span> <span class="n">balance</span> <span class="o">|</span> <span class="n">running</span> <span class="n">total</span> <span class="o">|</span>
<span class="o">+-----+-------+------+---------+---------------+</span>
<span class="o">|</span>   <span class="mi">1</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">10</span> <span class="o">|</span>     <span class="mi">100</span> <span class="o">|</span>           <span class="mi">100</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">2</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">20</span> <span class="o">|</span>     <span class="mi">200</span> <span class="o">|</span>           <span class="mi">350</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">3</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">20</span> <span class="o">|</span>      <span class="mi">50</span> <span class="o">|</span>           <span class="mi">350</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">4</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">35</span> <span class="o">|</span>     <span class="mi">150</span> <span class="o">|</span>           <span class="mi">500</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">5</span> <span class="o">|</span> <span class="n">CA</span>    <span class="o">|</span>   <span class="mi">18</span> <span class="o">|</span>     <span class="mi">150</span> <span class="o">|</span>           <span class="mi">250</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">6</span> <span class="o">|</span> <span class="n">CA</span>    <span class="o">|</span>   <span class="mi">18</span> <span class="o">|</span>     <span class="mi">100</span> <span class="o">|</span>           <span class="mi">250</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">7</span> <span class="o">|</span> <span class="n">CA</span>    <span class="o">|</span>   <span class="mi">30</span> <span class="o">|</span>     <span class="mi">200</span> <span class="o">|</span>           <span class="mi">450</span> <span class="o">|</span>
<span class="o">+-----+-------+------+---------+---------------+</span>
</pre></div>
</div>
</section>
<section id="solution">
<h2>3.Solution<a class="headerlink" href="#solution" title="Link to this heading">¶</a></h2>
<section id="how-it-works">
<h3>3.1 How It Works<a class="headerlink" href="#how-it-works" title="Link to this heading">¶</a></h3>
<p>By the examples above, we should be able to understand what an aggregate window function does conceptually. To implement, first we need to figure out how aggregate window functions work from iterative thinking. Let’s review the previous example and imagine a query engine behind it doing the calculation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+-----+-------+------+---------+---------------+</span>
<span class="o">|</span> <span class="n">no</span><span class="o">.</span> <span class="o">|</span> <span class="n">state</span> <span class="o">|</span> <span class="n">age</span>  <span class="o">|</span> <span class="n">balance</span> <span class="o">|</span> <span class="n">running</span> <span class="n">total</span> <span class="o">|</span>
<span class="o">+-----+-------+------+---------+---------------+</span> <span class="o">&lt;-</span> <span class="n">initial</span> <span class="n">state</span>
<span class="o">|</span>   <span class="mi">1</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">10</span> <span class="o">|</span>     <span class="mi">100</span> <span class="o">|</span>           <span class="mi">100</span> <span class="o">|</span> <span class="o">&lt;-</span> <span class="n">load</span> <span class="mi">100</span><span class="p">,</span> <span class="k">return</span> <span class="mi">100</span> <span class="k">as</span> <span class="nb">sum</span>
<span class="o">|</span>   <span class="mi">2</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">20</span> <span class="o">|</span>     <span class="mi">200</span> <span class="o">|</span>           <span class="mi">350</span> <span class="o">|</span> <span class="o">&lt;-</span> <span class="n">load</span> <span class="mi">200</span> <span class="ow">and</span> <span class="mi">50</span><span class="p">,</span> <span class="k">return</span> <span class="mi">350</span>
<span class="o">|</span>   <span class="mi">3</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">20</span> <span class="o">|</span>      <span class="mi">50</span> <span class="o">|</span>           <span class="mi">350</span> <span class="o">|</span> <span class="o">&lt;-</span> <span class="n">load</span> <span class="n">nothing</span><span class="p">,</span> <span class="k">return</span> <span class="mi">350</span> <span class="n">again</span>
<span class="o">|</span>   <span class="mi">4</span> <span class="o">|</span> <span class="n">WA</span>    <span class="o">|</span>   <span class="mi">35</span> <span class="o">|</span>     <span class="mi">150</span> <span class="o">|</span>           <span class="mi">500</span> <span class="o">|</span> <span class="o">&lt;-</span> <span class="n">load</span> <span class="mi">150</span><span class="p">,</span> <span class="k">return</span> <span class="mi">500</span>
<span class="o">|</span>   <span class="mi">5</span> <span class="o">|</span> <span class="n">CA</span>    <span class="o">|</span>   <span class="mi">18</span> <span class="o">|</span>     <span class="mi">150</span> <span class="o">|</span>           <span class="mi">250</span> <span class="o">|</span> <span class="o">&lt;-</span> <span class="n">new</span> <span class="n">partition</span><span class="p">,</span> <span class="n">reset</span> <span class="ow">and</span> <span class="n">load</span> <span class="mi">100</span> <span class="ow">and</span> <span class="mi">150</span>
<span class="o">|</span>   <span class="mi">6</span> <span class="o">|</span> <span class="n">CA</span>    <span class="o">|</span>   <span class="mi">18</span> <span class="o">|</span>     <span class="mi">100</span> <span class="o">|</span>           <span class="mi">250</span> <span class="o">|</span> <span class="o">&lt;-</span> <span class="n">load</span> <span class="n">nothing</span><span class="p">,</span> <span class="k">return</span> <span class="mi">250</span> <span class="n">again</span>
<span class="o">|</span>   <span class="mi">7</span> <span class="o">|</span> <span class="n">CA</span>    <span class="o">|</span>   <span class="mi">30</span> <span class="o">|</span>     <span class="mi">200</span> <span class="o">|</span>           <span class="mi">450</span> <span class="o">|</span> <span class="o">&lt;-</span> <span class="n">load</span> <span class="mi">200</span><span class="p">,</span> <span class="k">return</span> <span class="mi">450</span>
<span class="o">+-----+-------+------+---------+---------------+</span> <span class="o">&lt;-</span> <span class="n">no</span> <span class="n">more</span> <span class="n">data</span><span class="p">,</span> <span class="n">done</span>
</pre></div>
</div>
</section>
<section id="design">
<h3>3.2 Design<a class="headerlink" href="#design" title="Link to this heading">¶</a></h3>
<p>To explain the design in more intuitive way, formal sequence diagram in UML is not present here. Instead the following informal diagram illustrates how <code class="docutils literal notranslate"><span class="pre">WindowOperator</span></code>, <code class="docutils literal notranslate"><span class="pre">PeerRowsWindowFrame</span></code> and <code class="docutils literal notranslate"><span class="pre">AggregateWindowFunction</span></code> component work together as a whole to implement the same logic in last section.</p>
<p><img alt="High Level Design" src="../../_images/aggregate-window-functions.png" /></p>
</section>
<section id="performance">
<h3>3.3 Performance<a class="headerlink" href="#performance" title="Link to this heading">¶</a></h3>
<p>For time complexity, aggregate window functions are same as ranking functions which only scan input linearly. However, as for space complexity, there seems no way to avoid this memory consumption. Because more rows needs to be pre-fetched for calculation and meanwhile window operator need access to each previous row, one by one, as output.</p>
<p>In the worst case, all input data will be pulled out into window frame if:</p>
<ol class="arabic simple">
<li><p>Single partition due to no PARTITION BY clause</p></li>
<li><p>(and) All values of ORDER BY fields are exactly the same</p></li>
</ol>
<p>In this case, circuit breaker needs to be enabled to protect window operator from consuming large memory.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">sql-docs</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, josh.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../_sources/docs/dev/sql-aggregate-window-function.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>