<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Complex Queries &#8212; sql-docs  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="complex-queries">
<h1>Complex Queries<a class="headerlink" href="#complex-queries" title="Link to this heading">¶</a></h1>
<p class="rubric">Table of contents</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#subquery" id="id2">Subquery</a></p>
<ul>
<li><p><a class="reference internal" href="#description" id="id3">Description</a></p></li>
<li><p><a class="reference internal" href="#example-1-table-subquery" id="id4">Example 1: Table Subquery</a></p></li>
<li><p><a class="reference internal" href="#example-2-subquery-in-from-clause" id="id5">Example 2: Subquery in FROM Clause</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#joins" id="id6">JOINs</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id7">Description</a></p></li>
<li><p><a class="reference internal" href="#syntax" id="id8">Syntax</a></p></li>
<li><p><a class="reference internal" href="#example-1-inner-join" id="id9">Example 1: Inner Join</a></p></li>
<li><p><a class="reference internal" href="#example-2-cross-join" id="id10">Example 2: Cross Join</a></p></li>
<li><p><a class="reference internal" href="#example-3-outer-join" id="id11">Example 3: Outer Join</a></p></li>
</ul>
</li>
</ul>
</nav>
<p>Besides simple SFW queries (SELECT-FROM-WHERE), there is also support for complex queries such as Subquery, <code class="docutils literal notranslate"><span class="pre">JOIN</span></code>, <code class="docutils literal notranslate"><span class="pre">UNION</span></code> and <code class="docutils literal notranslate"><span class="pre">MINUS</span></code>. For these queries, more than one OpenSearch index and DSL query is involved. You can check out how they are performed behind the scene by our explain API.</p>
<section id="subquery">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Subquery</a><a class="headerlink" href="#subquery" title="Link to this heading">¶</a></h2>
<section id="description">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Link to this heading">¶</a></h3>
<p>A subquery is a complete <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> statement which is used within another statement and enclosed in parenthesis. From the explain output, you can notice that some subquery are actually transformed to an equivalent join query to execute.</p>
</section>
<section id="example-1-table-subquery">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Example 1: Table Subquery</a><a class="headerlink" href="#example-1-table-subquery" title="Link to this heading">¶</a></h3>
<p>SQL query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">_plugins</span><span class="o">/</span><span class="n">_sql</span>
<span class="p">{</span>
  <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT a1.firstname, a1.lastname, a1.balance</span>
<span class="s2">        FROM accounts a1</span>
<span class="s2">        WHERE a1.account_number IN (</span>
<span class="s2">          SELECT a2.account_number</span>
<span class="s2">          FROM accounts a2</span>
<span class="s2">          WHERE a2.balance &gt; 10000</span>
<span class="s2">        )</span>
<span class="s2">        &quot;&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Explain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;Physical Plan&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;Project [ columns=[a1.balance, a1.firstname, a1.lastname] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;Top [ count=200 ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BlockHashJoin[ conditions=( a1.account_number = a2.account_number ), type=JOIN, blockSize=[FixedBlockSize with size=10000] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;Scroll [ accounts as a2, pageSize=10000 ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;request&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
              <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bool&quot;</span> <span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                      <span class="s2">&quot;bool&quot;</span> <span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;adjust_pure_negative&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
                        <span class="s2">&quot;must&quot;</span> <span class="p">:</span> <span class="p">[</span>
                          <span class="p">{</span>
                            <span class="s2">&quot;bool&quot;</span> <span class="p">:</span> <span class="p">{</span>
                              <span class="s2">&quot;adjust_pure_negative&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
                              <span class="s2">&quot;must&quot;</span> <span class="p">:</span> <span class="p">[</span>
                                <span class="p">{</span>
                                  <span class="s2">&quot;bool&quot;</span> <span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;adjust_pure_negative&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
                                    <span class="s2">&quot;must_not&quot;</span> <span class="p">:</span> <span class="p">[</span>
                                      <span class="p">{</span>
                                        <span class="s2">&quot;bool&quot;</span> <span class="p">:</span> <span class="p">{</span>
                                          <span class="s2">&quot;adjust_pure_negative&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
                                          <span class="s2">&quot;must_not&quot;</span> <span class="p">:</span> <span class="p">[</span>
                                            <span class="p">{</span>
                                              <span class="s2">&quot;exists&quot;</span> <span class="p">:</span> <span class="p">{</span>
                                                <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;account_number&quot;</span><span class="p">,</span>
                                                <span class="s2">&quot;boost&quot;</span> <span class="p">:</span> <span class="mi">1</span>
                                              <span class="p">}</span>
                                            <span class="p">}</span>
                                          <span class="p">],</span>
                                          <span class="s2">&quot;boost&quot;</span> <span class="p">:</span> <span class="mi">1</span>
                                        <span class="p">}</span>
                                      <span class="p">}</span>
                                    <span class="p">],</span>
                                    <span class="s2">&quot;boost&quot;</span> <span class="p">:</span> <span class="mi">1</span>
                                  <span class="p">}</span>
                                <span class="p">},</span>
                                <span class="p">{</span>
                                  <span class="s2">&quot;range&quot;</span> <span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;balance&quot;</span> <span class="p">:</span> <span class="p">{</span>
                                      <span class="s2">&quot;include_lower&quot;</span> <span class="p">:</span> <span class="n">false</span><span class="p">,</span>
                                      <span class="s2">&quot;include_upper&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
                                      <span class="s2">&quot;from&quot;</span> <span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                                      <span class="s2">&quot;boost&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="s2">&quot;to&quot;</span> <span class="p">:</span> <span class="n">null</span>
                                    <span class="p">}</span>
                                  <span class="p">}</span>
                                <span class="p">}</span>
                              <span class="p">],</span>
                              <span class="s2">&quot;boost&quot;</span> <span class="p">:</span> <span class="mi">1</span>
                            <span class="p">}</span>
                          <span class="p">}</span>
                        <span class="p">],</span>
                        <span class="s2">&quot;boost&quot;</span> <span class="p">:</span> <span class="mi">1</span>
                      <span class="p">}</span>
                    <span class="p">}</span>
                  <span class="p">],</span>
                  <span class="s2">&quot;adjust_pure_negative&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
                  <span class="s2">&quot;boost&quot;</span> <span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
              <span class="p">},</span>
              <span class="s2">&quot;from&quot;</span> <span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="s2">&quot;Scroll [ accounts as a1, pageSize=10000 ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;request&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
              <span class="s2">&quot;from&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
              <span class="s2">&quot;_source&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;excludes&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">],</span>
                <span class="s2">&quot;includes&quot;</span> <span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;firstname&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;lastname&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;balance&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;account_number&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="s2">&quot;useTermsFilterOptimization&quot;</span> <span class="p">:</span> <span class="n">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;description&quot;</span> <span class="p">:</span> <span class="s2">&quot;Hash Join algorithm builds hash table based on result of first query, and then probes hash table to find matched rows for each row returned by second query&quot;</span><span class="p">,</span>
  <span class="s2">&quot;Logical Plan&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;Project [ columns=[a1.balance, a1.firstname, a1.lastname] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;Top [ count=200 ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;Join [ conditions=( a1.account_number = a2.account_number ) type=JOIN ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;Group&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s2">&quot;Project [ columns=[a1.balance, a1.firstname, a1.lastname, a1.account_number] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;TableScan&quot;</span> <span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;tableAlias&quot;</span> <span class="p">:</span> <span class="s2">&quot;a1&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;tableName&quot;</span> <span class="p">:</span> <span class="s2">&quot;accounts&quot;</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="s2">&quot;Project [ columns=[a2.account_number] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;Filter [ conditions=[AND ( AND account_number ISN null, AND balance GT 10000 ) ] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;TableScan&quot;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;tableAlias&quot;</span> <span class="p">:</span> <span class="s2">&quot;a2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tableName&quot;</span> <span class="p">:</span> <span class="s2">&quot;accounts&quot;</span>
                  <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Result set:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>a1.firstname</p></th>
<th class="head"><p>a1.lastname</p></th>
<th class="head"><p>a1.balance</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Amber</p></td>
<td><p>Duke</p></td>
<td><p>39225</p></td>
</tr>
<tr class="row-odd"><td><p>Nanette</p></td>
<td><p>Bates</p></td>
<td><p>32838</p></td>
</tr>
</tbody>
</table>
</section>
<section id="example-2-subquery-in-from-clause">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Example 2: Subquery in FROM Clause</a><a class="headerlink" href="#example-2-subquery-in-from-clause" title="Link to this heading">¶</a></h3>
<p>SQL query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">_plugins</span><span class="o">/</span><span class="n">_sql</span>
<span class="p">{</span>
  <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT a.f, a.l, a.a</span>
<span class="s2">        FROM (</span>
<span class="s2">          SELECT firstname AS f, lastname AS l, age AS a</span>
<span class="s2">          FROM accounts</span>
<span class="s2">          WHERE age &gt; 30</span>
<span class="s2">        ) AS a</span>
<span class="s2">        &quot;&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Explain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;from&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
  <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;bool&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;bool&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;must&quot;</span> <span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s2">&quot;range&quot;</span> <span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;age&quot;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;from&quot;</span> <span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                    <span class="s2">&quot;to&quot;</span> <span class="p">:</span> <span class="n">null</span><span class="p">,</span>
                    <span class="s2">&quot;include_lower&quot;</span> <span class="p">:</span> <span class="n">false</span><span class="p">,</span>
                    <span class="s2">&quot;include_upper&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
                    <span class="s2">&quot;boost&quot;</span> <span class="p">:</span> <span class="mf">1.0</span>
                  <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;adjust_pure_negative&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
            <span class="s2">&quot;boost&quot;</span> <span class="p">:</span> <span class="mf">1.0</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="s2">&quot;adjust_pure_negative&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
      <span class="s2">&quot;boost&quot;</span> <span class="p">:</span> <span class="mf">1.0</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;_source&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;includes&quot;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;firstname&quot;</span><span class="p">,</span>
      <span class="s2">&quot;lastname&quot;</span><span class="p">,</span>
      <span class="s2">&quot;age&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;excludes&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Result set:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>f</p></th>
<th class="head"><p>l</p></th>
<th class="head"><p>a</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Amber</p></td>
<td><p>Duke</p></td>
<td><p>32</p></td>
</tr>
<tr class="row-odd"><td><p>Dale</p></td>
<td><p>Adams</p></td>
<td><p>33</p></td>
</tr>
<tr class="row-even"><td><p>Hattie</p></td>
<td><p>Bond</p></td>
<td><p>36</p></td>
</tr>
</tbody>
</table>
<p>Here is another example with aggregation function and GROUP BY in subquery:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">&gt;</span> <span class="n">SELECT</span> <span class="n">avg_balance</span> <span class="n">FROM</span> <span class="p">(</span>
<span class="o">...</span>   <span class="n">SELECT</span> <span class="n">AVG</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span> <span class="n">AS</span> <span class="n">avg_balance</span> <span class="n">FROM</span> <span class="n">accounts</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">gender</span><span class="p">,</span> <span class="n">age</span>
<span class="o">...</span> <span class="p">)</span> <span class="n">AS</span> <span class="n">a</span><span class="p">;</span>
<span class="n">fetched</span> <span class="n">rows</span> <span class="o">/</span> <span class="n">total</span> <span class="n">rows</span> <span class="o">=</span> <span class="mi">4</span><span class="o">/</span><span class="mi">4</span>
<span class="o">+---------------+</span>
<span class="o">|</span> <span class="n">avg_balance</span>   <span class="o">|</span>
<span class="o">|---------------|</span>
<span class="o">|</span> <span class="mf">32838.0</span>       <span class="o">|</span>
<span class="o">|</span> <span class="mf">39225.0</span>       <span class="o">|</span>
<span class="o">|</span> <span class="mf">4180.0</span>        <span class="o">|</span>
<span class="o">|</span> <span class="mf">5686.0</span>        <span class="o">|</span>
<span class="o">+---------------+</span>
</pre></div>
</div>
<p>Query with multiple layers of subquery is supported as well, here follows a example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">&gt;</span> <span class="n">SELECT</span> <span class="n">name</span> <span class="n">FROM</span> <span class="p">(</span>
<span class="o">...</span>   <span class="n">SELECT</span> <span class="n">lastname</span> <span class="n">AS</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span> <span class="n">FROM</span> <span class="p">(</span>
<span class="o">...</span>     <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">accounts</span> <span class="n">WHERE</span> <span class="n">gender</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span>
<span class="o">...</span>   <span class="p">)</span> <span class="n">AS</span> <span class="n">accounts</span> <span class="n">WHERE</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">35</span>
<span class="o">...</span> <span class="p">)</span> <span class="n">AS</span> <span class="n">accounts</span>
<span class="n">fetched</span> <span class="n">rows</span> <span class="o">/</span> <span class="n">total</span> <span class="n">rows</span> <span class="o">=</span> <span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
<span class="o">+--------+</span>
<span class="o">|</span> <span class="n">name</span>   <span class="o">|</span>
<span class="o">|--------|</span>
<span class="o">|</span> <span class="n">Duke</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">Adams</span>  <span class="o">|</span>
<span class="o">+--------+</span>
</pre></div>
</div>
</section>
</section>
<section id="joins">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">JOINs</a><a class="headerlink" href="#joins" title="Link to this heading">¶</a></h2>
<section id="id1">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Description</a><a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">JOIN</span></code> clause combines columns from one or more indices by using values common to each.</p>
</section>
<section id="syntax">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Syntax</a><a class="headerlink" href="#syntax" title="Link to this heading">¶</a></h3>
<p>Rule <code class="docutils literal notranslate"><span class="pre">tableSource</span></code>:</p>
<img alt="../../../_images/tableSource.png" src="../../../_images/tableSource.png" />
<p>Rule <code class="docutils literal notranslate"><span class="pre">joinPart</span></code>:</p>
<img alt="../../../_images/joinPart.png" src="../../../_images/joinPart.png" />
</section>
<section id="example-1-inner-join">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Example 1: Inner Join</a><a class="headerlink" href="#example-1-inner-join" title="Link to this heading">¶</a></h3>
<p>Inner join is very commonly used that creates a new result set by combining columns of two indices based on the join predicates specified. It iterates both indices and compare each document to find all that satisfy the join predicates. Keyword <code class="docutils literal notranslate"><span class="pre">JOIN</span></code> is used and preceded by <code class="docutils literal notranslate"><span class="pre">INNER</span></code> keyword optionally. The join predicate(s) is specified by <code class="docutils literal notranslate"><span class="pre">ON</span></code> clause.</p>
<blockquote>
<div><p>Remark that the explain API output for join queries looks complicated. This is because a join query is associated with two OpenSearch DSL queries underlying and execute in the separate query planner framework. You can interpret it by looking into the logical plan and physical plan.</p>
</div></blockquote>
<p>SQL query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">_plugins</span><span class="o">/</span><span class="n">_sql</span>
<span class="p">{</span>
  <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT</span>
<span class="s2">          a.account_number, a.firstname, a.lastname,</span>
<span class="s2">          e.id, e.name</span>
<span class="s2">        FROM accounts a</span>
<span class="s2">        JOIN employees_nested e</span>
<span class="s2">         ON a.account_number = e.id</span>
<span class="s2">        &quot;&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Explain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;Physical Plan&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;Project [ columns=[a.account_number, a.firstname, a.lastname, e.name, e.id] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;Top [ count=200 ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BlockHashJoin[ conditions=( a.account_number = e.id ), type=JOIN, blockSize=[FixedBlockSize with size=10000] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;Scroll [ employees_nested as e, pageSize=10000 ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;request&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
              <span class="s2">&quot;from&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
              <span class="s2">&quot;_source&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;excludes&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">],</span>
                <span class="s2">&quot;includes&quot;</span> <span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;id&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;name&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="s2">&quot;Scroll [ accounts as a, pageSize=10000 ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;request&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
              <span class="s2">&quot;from&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
              <span class="s2">&quot;_source&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;excludes&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">],</span>
                <span class="s2">&quot;includes&quot;</span> <span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;account_number&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;firstname&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;lastname&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="s2">&quot;useTermsFilterOptimization&quot;</span> <span class="p">:</span> <span class="n">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;description&quot;</span> <span class="p">:</span> <span class="s2">&quot;Hash Join algorithm builds hash table based on result of first query, and then probes hash table to find matched rows for each row returned by second query&quot;</span><span class="p">,</span>
  <span class="s2">&quot;Logical Plan&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;Project [ columns=[a.account_number, a.firstname, a.lastname, e.name, e.id] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;Top [ count=200 ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;Join [ conditions=( a.account_number = e.id ) type=JOIN ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;Group&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s2">&quot;Project [ columns=[a.account_number, a.firstname, a.lastname] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;TableScan&quot;</span> <span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;tableAlias&quot;</span> <span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;tableName&quot;</span> <span class="p">:</span> <span class="s2">&quot;accounts&quot;</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="s2">&quot;Project [ columns=[e.name, e.id] ]&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;TableScan&quot;</span> <span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;tableAlias&quot;</span> <span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;tableName&quot;</span> <span class="p">:</span> <span class="s2">&quot;employees_nested&quot;</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Result set:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>a.account_number</p></th>
<th class="head"><p>a.firstname</p></th>
<th class="head"><p>a.lastname</p></th>
<th class="head"><p>e.id</p></th>
<th class="head"><p>e.name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>6</p></td>
<td><p>Hattie</p></td>
<td><p>Bond</p></td>
<td><p>6</p></td>
<td><p>Jane Smith</p></td>
</tr>
</tbody>
</table>
</section>
<section id="example-2-cross-join">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Example 2: Cross Join</a><a class="headerlink" href="#example-2-cross-join" title="Link to this heading">¶</a></h3>
<p>Cross join or Cartesian join combines each document from the first index with each from the second. The result set is the Cartesian Product of documents from both indices. It appears to be similar to inner join without <code class="docutils literal notranslate"><span class="pre">ON</span></code> clause to specify join condition.</p>
<blockquote>
<div><p>Caveat: It is risky to do cross join even on two indices of medium size. This may trigger our circuit breaker to terminate the query to avoid out of memory issue.</p>
</div></blockquote>
<p>SQL query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">_plugins</span><span class="o">/</span><span class="n">_sql</span>
<span class="p">{</span>
  <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT</span>
<span class="s2">          a.account_number, a.firstname, a.lastname,</span>
<span class="s2">          e.id, e.name</span>
<span class="s2">        FROM accounts a</span>
<span class="s2">        JOIN employees_nested e</span>
<span class="s2">        &quot;&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Result set:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>a.account_number</p></th>
<th class="head"><p>a.firstname</p></th>
<th class="head"><p>a.lastname</p></th>
<th class="head"><p>e.id</p></th>
<th class="head"><p>e.name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Amber</p></td>
<td><p>Duke</p></td>
<td><p>3</p></td>
<td><p>Bob Smith</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Amber</p></td>
<td><p>Duke</p></td>
<td><p>4</p></td>
<td><p>Susan Smith</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>Amber</p></td>
<td><p>Duke</p></td>
<td><p>6</p></td>
<td><p>Jane Smith</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>Hattie</p></td>
<td><p>Bond</p></td>
<td><p>3</p></td>
<td><p>Bob Smith</p></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>Hattie</p></td>
<td><p>Bond</p></td>
<td><p>4</p></td>
<td><p>Susan Smith</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>Hattie</p></td>
<td><p>Bond</p></td>
<td><p>6</p></td>
<td><p>Jane Smith</p></td>
</tr>
<tr class="row-even"><td><p>13</p></td>
<td><p>Nanette</p></td>
<td><p>Bates</p></td>
<td><p>3</p></td>
<td><p>Bob Smith</p></td>
</tr>
<tr class="row-odd"><td><p>13</p></td>
<td><p>Nanette</p></td>
<td><p>Bates</p></td>
<td><p>4</p></td>
<td><p>Susan Smith</p></td>
</tr>
<tr class="row-even"><td><p>13</p></td>
<td><p>Nanette</p></td>
<td><p>Bates</p></td>
<td><p>6</p></td>
<td><p>Jane Smith</p></td>
</tr>
<tr class="row-odd"><td><p>18</p></td>
<td><p>Dale</p></td>
<td><p>Adams</p></td>
<td><p>3</p></td>
<td><p>Bob Smith</p></td>
</tr>
<tr class="row-even"><td><p>18</p></td>
<td><p>Dale</p></td>
<td><p>Adams</p></td>
<td><p>4</p></td>
<td><p>Susan Smith</p></td>
</tr>
<tr class="row-odd"><td><p>18</p></td>
<td><p>Dale</p></td>
<td><p>Adams</p></td>
<td><p>6</p></td>
<td><p>Jane Smith</p></td>
</tr>
</tbody>
</table>
</section>
<section id="example-3-outer-join">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Example 3: Outer Join</a><a class="headerlink" href="#example-3-outer-join" title="Link to this heading">¶</a></h3>
<p>Outer join is used to retain documents from one or both indices although it does not satisfy join predicate. For now, only <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code> is supported to retain rows from first index. Note that keyword <code class="docutils literal notranslate"><span class="pre">OUTER</span></code> is optional.</p>
<p>SQL query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">_plugins</span><span class="o">/</span><span class="n">_sql</span>
<span class="p">{</span>
  <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT</span>
<span class="s2">          a.account_number, a.firstname, a.lastname,</span>
<span class="s2">          e.id, e.name</span>
<span class="s2">        FROM accounts a</span>
<span class="s2">        LEFT JOIN employees_nested e</span>
<span class="s2">         ON a.account_number = e.id</span>
<span class="s2">        &quot;&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Result set:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>a.account_number</p></th>
<th class="head"><p>a.firstname</p></th>
<th class="head"><p>a.lastname</p></th>
<th class="head"><p>e.id</p></th>
<th class="head"><p>e.name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Amber</p></td>
<td><p>Duke</p></td>
<td><p>null</p></td>
<td><p>null</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>Hattie</p></td>
<td><p>Bond</p></td>
<td><p>6</p></td>
<td><p>Jane Smith</p></td>
</tr>
<tr class="row-even"><td><p>13</p></td>
<td><p>Nanette</p></td>
<td><p>Bates</p></td>
<td><p>null</p></td>
<td><p>null</p></td>
</tr>
<tr class="row-odd"><td><p>18</p></td>
<td><p>Dale</p></td>
<td><p>Adams</p></td>
<td><p>null</p></td>
<td><p>null</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">sql-docs</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, josh.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../../_sources/docs/user/dql/complex.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>