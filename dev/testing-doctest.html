<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Doctest &#8212; Example 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=12dfc556" />
    <script src="../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="doctest">
<h1>Doctest<a class="headerlink" href="#doctest" title="Link to this heading">¶</a></h1>
</section>
<section id="overview">
<h1>1. Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h1>
<section id="what-is-doctest">
<h2>1.1 What is doctest?<a class="headerlink" href="#what-is-doctest" title="Link to this heading">¶</a></h2>
<p>Doctest is a way to test code by checking the correctness of embedded interactive examples in documentation
<a class="reference external" href="https://docs.python.org/3/library/doctest.html#simple-usage-checking-examples-in-a-text-file">example explaining doctest module</a></p>
<p><code class="docutils literal notranslate"><span class="pre">example.txt</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>This is an example text file in reStructuredText format.  First import
``factorial`` from the ``example`` module:

    **&gt;&gt;&gt; from example import factorial**

Now use it:

    **&gt;&gt;&gt; factorial(6)
    120**
</pre></div>
</div>
<p>Running <code class="docutils literal notranslate"><span class="pre">doctest.testfile(&quot;example.txt&quot;)</span></code> then finds the error</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">File</span> <span class="s2">&quot;./example.txt&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">14</span><span class="p">,</span> <span class="ow">in</span> <span class="n">example</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Failed</span> <span class="n">example</span><span class="p">:</span>
    <span class="n">factorial</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">Expected</span><span class="p">:</span>
    <span class="mi">120</span>
<span class="n">Got</span><span class="p">:</span>
    <span class="mi">720</span>
</pre></div>
</div>
</section>
<section id="why-use-doctest">
<h2>1.2 Why use doctest?<a class="headerlink" href="#why-use-doctest" title="Link to this heading">¶</a></h2>
<p>Doctest can make the code snippet in docs executable, and check its response as well.</p>
<p>As mentioned in the python doctest <a class="reference external" href="https://docs.python.org/3/library/doctest.html#">introduction</a>, doctest has grown to have three primary uses:</p>
<ol class="arabic simple">
<li><p>Checking examples in docstrings.</p></li>
<li><p>Regression testing.</p></li>
<li><p>Executable documentation / literate testing.</p></li>
</ol>
</section>
<section id="how-does-it-affect-unit-integration-testing-suite">
<h2>1.3 How does it affect unit/integration testing suite?<a class="headerlink" href="#how-does-it-affect-unit-integration-testing-suite" title="Link to this heading">¶</a></h2>
<p>Both doctest and unit/integration test are valuable. Use doctest for cases where the test is giving an example of usage that is actually useful as documentation. Generally, don’t make these tests comprehensive, aiming solely for informative. Use doctest in reverse: <strong>not to test the code is correct based on doctest, but to check that documentation is correct based on the code.</strong></p>
<p>For actually testing the code, the goal is to thoroughly test every case, rather than illustrate what it does by example. Doctests aren’t meant to be a comprehensive testing solution - they’re meant to ensure that simple interactive-prompt style examples in your documentation (including docstrings) don’t get out of date.</p>
</section>
<section id="how-to-use-doctest">
<h2>1.4 How to use doctest?<a class="headerlink" href="#how-to-use-doctest" title="Link to this heading">¶</a></h2>
<section id="how-to-run-existing-doctest">
<h3>1.4.2 How to run existing doctest?<a class="headerlink" href="#how-to-run-existing-doctest" title="Link to this heading">¶</a></h3>
<p>Doctest runs with project build by <code class="docutils literal notranslate"><span class="pre">./gradlew</span> <span class="pre">build</span></code>. You can also only run doctest by <code class="docutils literal notranslate"><span class="pre">./gradlew</span> <span class="pre">doctest</span></code></p>
<p>Make sure you don’t have any OpenSearch instance running at <code class="docutils literal notranslate"><span class="pre">http://localhost:9200</span></code></p>
</section>
<section id="how-to-write-documentation-with-doctest">
<h3>1.4.2 How to write documentation with doctest?<a class="headerlink" href="#how-to-write-documentation-with-doctest" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>If you want to add a new doc, you can add it to <code class="docutils literal notranslate"><span class="pre">docs</span></code> folder, under correct sub-folder, in <code class="docutils literal notranslate"><span class="pre">.rst</span></code> format.</p></li>
</ol>
<blockquote>
<div><p><strong>Attention</strong>: For code examples in documentation, a Mixing usage of <code class="docutils literal notranslate"><span class="pre">cli</span></code> and <code class="docutils literal notranslate"><span class="pre">bash</span></code> in one doc is not supported yet.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Add your new doc file path to <code class="docutils literal notranslate"><span class="pre">docs/category.json</span></code> by its category</p></li>
<li><p>Run doctest <code class="docutils literal notranslate"><span class="pre">./gradlew</span> <span class="pre">doctest</span></code> to see if your tests can pass</p></li>
</ol>
<p>Currently, there is a <code class="docutils literal notranslate"><span class="pre">sample</span></code> folder under <code class="docutils literal notranslate"><span class="pre">docs</span></code> module to help you get started.</p>
</section>
</section>
<section id="future-plan">
<h2>1.5 Future Plan<a class="headerlink" href="#future-plan" title="Link to this heading">¶</a></h2>
<p>Current SQL Documentation will need reconstruction in the future. Ideally, both SQL and PPL doctest will integrate/migrate to a separate Doctest module in the new architecture.</p>
</section>
</section>
<section id="design">
<h1>2. Design<a class="headerlink" href="#design" title="Link to this heading">¶</a></h1>
<section id="workflow">
<h2>2.1 Workflow<a class="headerlink" href="#workflow" title="Link to this heading">¶</a></h2>
<p><img alt="doctest-workflow" src="../_images/doctest-workflow.png" /></p>
</section>
<section id="opensearch-test-instance">
<h2>2.2 OpenSearch Test Instance<a class="headerlink" href="#opensearch-test-instance" title="Link to this heading">¶</a></h2>
<section id="testing-framework">
<h3>2.2.1 Testing framework<a class="headerlink" href="#testing-framework" title="Link to this heading">¶</a></h3>
<p>We have two options here</p>
<ol class="arabic simple">
<li><p>Use OpenSearch integration testing framework, same as SQL Plugin integration test.</p></li>
<li><p>Spin up OpenSearch instance with SQL Plugin installed without gradle build the package, simply <code class="docutils literal notranslate"><span class="pre">./gradlew</span> <span class="pre">run</span></code></p></li>
</ol>
<p>The reason we are not using OpenSearch test framework, is due to the difficulty of integrating Python code to a Java based framework, considering we are using python built-in module <code class="docutils literal notranslate"><span class="pre">doctest</span></code> for implementation</p>
</section>
<section id="gradle">
<h3>2.2.2 Gradle<a class="headerlink" href="#gradle" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Create new module/packdage <code class="docutils literal notranslate"><span class="pre">doctest</span></code> under current <code class="docutils literal notranslate"><span class="pre">opensearch-sql</span></code>, and integrate to gradle management</p>
<ol class="arabic simple">
<li><p><img alt="doctest-gradle-project-structure" src="../_images/doctest-gradle-project-structure.png" /></p></li>
</ol>
</li>
<li><p>Set up gradle build script, which enables doctest by <code class="docutils literal notranslate"><span class="pre">./gradlew</span> <span class="pre">doctest</span></code></p></li>
<li><p>Gradle tasks:</p>
<ol class="arabic simple">
<li><p>bootstrap</p></li>
<li><p>StartOpenSearch</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"> <span class="pre">./gradlew</span> <span class="pre">run</span></code></p></li>
<li><p>https://github.com/elastic/elasticsearch/blob/main/TESTING.asciidoc#running-elasticsearch-from-a-checkout</p></li>
</ol>
</li>
<li><p>doctest</p></li>
<li><p>StopOpenSearch</p></li>
</ol>
</li>
<li><p>Integrate Doctest to project gradle build, which means <code class="docutils literal notranslate"><span class="pre">./gradlew</span> <span class="pre">build</span></code> will also run <code class="docutils literal notranslate"><span class="pre">doctest</span></code></p></li>
</ol>
</section>
<section id="project-structure">
<h3><strong>2.2.3 Project Structure</strong><a class="headerlink" href="#project-structure" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">bootstrap.sh</span></code>   set up virtual environment for python module</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>doctest
├── bin
│   └── test-docs
├── bootstrap.sh
├── build.gradle
├── docs
│   └── dql
│       ├── basics.rst
│       └── explain.rst
├── requirements.txt
├── test_data
│   └── accounts.json
└── test_docs.py
</pre></div>
</div>
</section>
</section>
<section id="parsers">
<h2>2.3 Parsers<a class="headerlink" href="#parsers" title="Link to this heading">¶</a></h2>
<blockquote>
<div><p><strong>How are Docstring Examples Recognized?</strong>
In most cases, a copy-and-paste of an interactive console session works fine, but doctest isn’t trying to do an exact emulation of any specific Python shell.</p>
</div></blockquote>
<p>Doctest is relying on the console/command line to run code examples in documentation. So we need two parsers here.</p>
<section id="cli-parser">
<h3>2.3.1 CLI parser<a class="headerlink" href="#cli-parser" title="Link to this heading">¶</a></h3>
<p><strong>Reference: <a class="reference external" href="https://github.com/crate/crate/blob/master/blackbox/test_docs.py">CrateDB Implementation</a></strong></p>
<ul class="simple">
<li><p>To recognize its own cli and bash, CrateDB customize the doctest parser by a 3rd party libary:  <a class="reference external" href="https://pypi.org/project/zc.customdoctests/">zc.customdoctests</a></p></li>
<li><p>CrateDB doctest uses it’s own cli <code class="docutils literal notranslate"><span class="pre">crash</span></code> to run doctests. https://github.com/crate/crash</p>
<ul>
<li><p>https://github.com/crate/crate/blob/master/docs/general/dql/selects.rst</p></li>
</ul>
</li>
</ul>
<p>Similar to CrateDB using it’s CLI “crash”, we can make use of our own <a class="reference external" href="https://github.com/opensearch-project/sql/tree/main/sql-cli">SQL-CLI</a></p>
<p>To support PPL, we need to add PPL support to SQL-CLI. Since PPL and SQL expose similar http endpoint for query and share similar response format. The update won’t be much of work.</p>
<p>The code example in a doc using <code class="docutils literal notranslate"><span class="pre">CLI</span></code> should be like this</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">opensearchsql</span><span class="o">&gt;</span> <span class="n">SELECT</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span> <span class="n">FROM</span> <span class="n">accounts</span><span class="p">;</span>
<span class="n">fetched</span> <span class="n">rows</span> <span class="o">/</span> <span class="n">total</span> <span class="n">rows</span> <span class="o">=</span> <span class="mi">4</span><span class="o">/</span><span class="mi">4</span>
<span class="o">+-------------+------------+</span>
<span class="o">|</span> <span class="n">firstname</span>   <span class="o">|</span> <span class="n">lastname</span>   <span class="o">|</span>
<span class="o">|-------------+------------|</span>
<span class="o">|</span> <span class="n">Amber</span>       <span class="o">|</span> <span class="n">Duke</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Hattie</span>      <span class="o">|</span> <span class="n">Bond</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">Nanette</span>     <span class="o">|</span> <span class="n">Bates</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Dale</span>        <span class="o">|</span> <span class="n">Adams</span>      <span class="o">|</span>
<span class="o">+-------------+------------+</span>
</pre></div>
</div>
</section>
<section id="bash-parser">
<h3>2.3.2 bash parser<a class="headerlink" href="#bash-parser" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Use <a class="reference external" href="https://docs.python.org/3/library/subprocess.html">python subprocess</a> to run <code class="docutils literal notranslate"><span class="pre">curl</span></code> command</p></li>
<li><p>Need to add additional formatter to better display json response</p></li>
</ol>
<p>The code example in a doc using <code class="docutils literal notranslate"><span class="pre">bash</span></code> should be like this</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -XPOST &quot;localhost:9200/_plugins/_ppl/&quot; 
          -H &#39;Content-Type: application/json&#39; 
          -d&#39;{  &quot;query&quot;: &quot;search source=opensearch_dashboards_sample_data_flights OriginCountry = &quot;IT&quot; 
          DestiContry = &quot;US&quot; | fields FlightNum, DestCountry, OriginCountry &quot;}&#39;
   
    {
      {
        &quot;FlightNum&quot;: &quot;ADGH12&quot;,
        &quot;OriginCountry&quot;: &quot;IT&quot;,
        &quot;DestCountry&quot;: &quot;US&quot;
      },
      {
        &quot;FlightNum&quot;: &quot;IRMW49&quot;,
        &quot;OriginCountry&quot;: &quot;IT&quot;,
        &quot;DestCountry&quot;: &quot;US&quot;
      },
      ...
    }
</pre></div>
</div>
</section>
</section>
<section id="test-data">
<h2>2.3 Test Data<a class="headerlink" href="#test-data" title="Link to this heading">¶</a></h2>
<p>Use elasticsearch python library to create connection to OpenSearch instance. It can load test data into OpenSearch instance, and delete test index after testing.</p>
<p><strong>Setup:</strong> <code class="docutils literal notranslate"><span class="pre">bulk</span></code> API
<strong>TearDown:</strong> <code class="docutils literal notranslate"><span class="pre">delete(index=[&quot;&lt;test_index&gt;&quot;])</span></code></p>
</section>
<section id="test-report">
<h2>2.3 Test Report<a class="headerlink" href="#test-report" title="Link to this heading">¶</a></h2>
<section id="print-results">
<h3>2.3.1 Print results<a class="headerlink" href="#print-results" title="Link to this heading">¶</a></h3>
<p>Use python faulthandler from script to print results</p>
<p>https://docs.python.org/3/library/faulthandler.html</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">Task</span> <span class="p">:</span><span class="n">doctest</span><span class="p">:</span><span class="n">doctest</span>
<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">szhongna</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">sql</span><span class="o">/</span><span class="n">doctest</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">dql</span><span class="o">/</span><span class="n">basics</span><span class="o">.</span><span class="n">rst</span>
<span class="n">Doctest</span><span class="p">:</span> <span class="n">basics</span><span class="o">.</span><span class="n">rst</span> <span class="o">...</span> <span class="n">ok</span>
<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">szhongna</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">sql</span><span class="o">/</span><span class="n">doctest</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">dql</span><span class="o">/</span><span class="n">explain</span><span class="o">.</span><span class="n">rst</span>
<span class="n">Doctest</span><span class="p">:</span> <span class="n">explain</span><span class="o">.</span><span class="n">rst</span> <span class="o">...</span> <span class="n">FAIL</span>

<span class="o">======================================================================</span>
<span class="n">FAIL</span><span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">szhongna</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">sql</span><span class="o">/</span><span class="n">doctest</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">dql</span><span class="o">/</span><span class="n">explain</span><span class="o">.</span><span class="n">rst</span>
<span class="n">Doctest</span><span class="p">:</span> <span class="n">explain</span><span class="o">.</span><span class="n">rst</span>

<span class="o">----------------------------------------------------------------------</span>
<span class="n">File</span> <span class="s2">&quot;/Users/szhongna/Desktop/Projects/sql/doctest/docs/dql/explain.rst&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">6</span><span class="p">,</span> <span class="ow">in</span> <span class="n">explain</span><span class="o">.</span><span class="n">rst</span>
<span class="n">Failed</span> <span class="n">example</span><span class="p">:</span>
    <span class="n">pretty_print</span><span class="p">(</span><span class="n">sh</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;curl -sS -H &#39;Content-Type: application/json&#39; </span><span class="se">\</span>
<span class="s2">    -X POST localhost:9200/_plugins/_sql/_explain </span><span class="se">\</span>
<span class="s2">    -d &#39;{&quot;query&quot; : &quot;SELECT firstname, lastname FROM accounts WHERE age &gt; 20&quot;}&#39;</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
<span class="n">Expected</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
       
       <span class="o">...</span> 
       
       <span class="p">}</span>
    <span class="p">}</span>
<span class="n">Got</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
      
        <span class="o">...</span> 
      
      <span class="p">}</span>
    <span class="p">}</span>


<span class="o">----------------------------------------------------------------------</span>
<span class="n">Ran</span> <span class="mi">2</span> <span class="n">tests</span> <span class="ow">in</span> <span class="mf">2.963</span><span class="n">s</span>

<span class="n">FAILED</span> <span class="p">(</span><span class="n">failures</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="o">&gt;</span> <span class="n">Task</span> <span class="p">:</span><span class="n">doctest</span><span class="p">:</span><span class="n">doctest</span> <span class="n">FAILED</span>

<span class="n">FAILURE</span><span class="p">:</span> <span class="n">Build</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">an</span> <span class="n">exception</span><span class="o">.</span>

</pre></div>
</div>
</section>
<section id="generate-report">
<h3>2.3.2 generate report<a class="headerlink" href="#generate-report" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Python tests can’t be integrated to Jacoco test reporting</p></li>
<li><p>TODO: need to figure out a better solution</p></li>
</ul>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Example</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;workshop participant.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../_sources/dev/testing-doctest.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>