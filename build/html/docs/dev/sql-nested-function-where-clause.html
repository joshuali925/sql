<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Description &#8212; sql-docs  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="description">
<h1>Description<a class="headerlink" href="#description" title="Link to this heading">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">nested</span></code> function when used in the <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause of an SQL statement filters documents of <code class="docutils literal notranslate"><span class="pre">nested</span></code> object type based on field properties. Two syntax options are available to users, see section <a class="reference internal" href="#11-syntax"><span class="xref myst">1.1 Syntax</span></a>. Both syntax options achieve the goal of filtering a <code class="docutils literal notranslate"><span class="pre">nested</span></code> field with an <code class="docutils literal notranslate"><span class="pre">Operator</span></code> and a <code class="docutils literal notranslate"><span class="pre">Literal</span></code> value. Although semantically the syntax options can produce the same query, they will produce different DSL to push to OpenSearch. This difference is based on the <code class="docutils literal notranslate"><span class="pre">AND/OR/NOT</span></code> boolean queries residing inside a <code class="docutils literal notranslate"><span class="pre">nested</span></code> query or vice versa. See section <a class="reference internal" href="#21-syntax-option-1-object-tree-to-dsl"><span class="xref myst">2.1</span></a> and <a class="reference internal" href="#22-syntax-option-2-object-tree-to-dsl"><span class="xref myst">2.2</span></a> for examples depicting this alternate DSL creation. Testing large groups of push down execution times for identical queries using the different syntax options showed a nominal difference of approximately 3% for Syntax option 2.</p>
</section>
<section id="table-of-contents">
<h1>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading">¶</a></h1>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#1-overview"><span class="xref myst">Overview</span></a></p></li>
<li><p><a class="reference internal" href="#11-syntax"><span class="xref myst">Syntax</span></a></p></li>
<li><p><a class="reference internal" href="#12-changes-to-core"><span class="xref myst">Changes To Core</span></a></p></li>
<li><p><a class="reference internal" href="#13-example-data-and-usage"><span class="xref myst">Example Data And Usage</span></a></p></li>
<li><p><a class="reference internal" href="#14-example-queries"><span class="xref myst">Example Queries</span></a></p></li>
<li><p><a class="reference internal" href="#2-architecture-diagrams"><span class="xref myst">Architecture Diagrams</span></a></p></li>
<li><p><a class="reference internal" href="#21-syntax-option-1-object-tree-to-dsl"><span class="xref myst">Syntax Option 1 Object Tree to DSL</span></a></p></li>
<li><p><a class="reference internal" href="#22-syntax-option-2-object-tree-to-dsl"><span class="xref myst">Syntax Option 2 Object Tree to DSL</span></a></p></li>
<li><p><a class="reference internal" href="#additional-info"><span class="xref myst">Additional Info</span></a></p></li>
<li><p><a class="reference internal" href="#release-schedule"><span class="xref myst">Release Schedule</span></a></p></li>
</ol>
</section>
<section id="overview">
<h1>1 Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h1>
<section id="syntax">
<h2>1.1 Syntax<a class="headerlink" href="#syntax" title="Link to this heading">¶</a></h2>
<p>The nested function has two syntax options when used in the <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause of an SQL statement. Both syntax options can produce the same OpenSearch response, but will form different DSL used in the query.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nested(path,</span> <span class="pre">condition)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nested(field</span> <span class="pre">|</span> <span class="pre">field,</span> <span class="pre">path)</span> <span class="pre">OPERATOR</span> <span class="pre">LITERAL</span></code></p></li>
</ol>
</section>
<section id="changes-to-core">
<h2>1.2 Changes To Core<a class="headerlink" href="#changes-to-core" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><strong>FilterQueryBuilder:</strong> Added logic to handle <code class="docutils literal notranslate"><span class="pre">nested</span></code> functions in <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause as predicate expression and <code class="docutils literal notranslate"><span class="pre">FunctionExpression</span></code>.</p></li>
<li><p><strong>LuceneQuery:</strong> Added logic to handle <code class="docutils literal notranslate"><span class="pre">nested</span></code> functions and <code class="docutils literal notranslate"><span class="pre">FunctionExpression</span></code>’s on both sides of <code class="docutils literal notranslate"><span class="pre">OPERATOR</span></code> in <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause.</p></li>
</ul>
</section>
<section id="example-data-and-usage">
<h2>1.3 Example Data and Usage<a class="headerlink" href="#example-data-and-usage" title="Link to this heading">¶</a></h2>
<p>A basic example from data mapping to response from SQL plugin.</p>
<p><strong>Mapping:</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;mappings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;properties&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nested&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;properties&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;info&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;keyword&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;index&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;true&quot;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Dataset:</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;index&quot;</span><span class="p">:{</span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="nt">&quot;message&quot;</span><span class="p">:{</span><span class="nt">&quot;info&quot;</span><span class="p">:</span><span class="s2">&quot;a&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="nt">&quot;index&quot;</span><span class="p">:{</span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;2&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="nt">&quot;message&quot;</span><span class="p">:{</span><span class="nt">&quot;info&quot;</span><span class="p">:</span><span class="s2">&quot;c&quot;</span><span class="p">}}</span>
</pre></div>
</div>
<p><strong>Query:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span> <span class="pre">FROM</span> <span class="pre">nested_objects</span> <span class="pre">WHERE</span> <span class="pre">nested(message,</span> <span class="pre">message.info</span> <span class="pre">=</span> <span class="pre">'a');</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span> <span class="pre">FROM</span> <span class="pre">nested_objects</span> <span class="pre">WHERE</span> <span class="pre">nested(message.info)</span> <span class="pre">=</span> <span class="pre">'a';</span></code></p></li>
</ul>
<p>Both queries produce same response from OpenSearch.</p>
<p><strong>Response:</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;schema&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nested&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;datarows&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">[</span>
<span class="w">      </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;info&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;total&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="example-queries">
<h2>1.4 Example Queries<a class="headerlink" href="#example-queries" title="Link to this heading">¶</a></h2>
<p>A basic nested function in the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause. This example filters the <code class="docutils literal notranslate"><span class="pre">nested</span></code> object <code class="docutils literal notranslate"><span class="pre">message</span></code> and the inner field <code class="docutils literal notranslate"><span class="pre">info</span></code> with the value of <code class="docutils literal notranslate"><span class="pre">a</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span> <span class="pre">FROM</span> <span class="pre">nested_objects</span> <span class="pre">WHERE</span> <span class="pre">nested(message.info)</span> <span class="pre">=</span> <span class="pre">'a'</span> <span class="pre">OR</span> <span class="pre">nested(message.author)</span> <span class="pre">=</span> <span class="pre">'elm';</span></code></p></li>
</ul>
<p>Using the same query as above but with syntax option 1, the response from OpenSearch will be the same, but the DSL used in the query will differ.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span> <span class="pre">FROM</span> <span class="pre">nested_objects</span> <span class="pre">WHERE</span> <span class="pre">nested(message,</span> <span class="pre">message.info</span> <span class="pre">=</span> <span class="pre">'a'</span> <span class="pre">OR</span> <span class="pre">messate.author</span> <span class="pre">=</span> <span class="pre">'elm');</span></code></p></li>
</ul>
<p>This example has a nested function in the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause and the <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause of the query. Using the <code class="docutils literal notranslate"><span class="pre">nested</span></code> function in the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause will flatten the response nested objects from OpenSearch. See <a class="reference internal" href="sql-nested-function-select-clause.html"><span class="std std-doc">Nested In Select</span></a> for more details on flattening.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">nested(message.info)</span> <span class="pre">FROM</span> <span class="pre">nested_objects</span> <span class="pre">WHERE</span> <span class="pre">nested(message.info)</span> <span class="pre">=</span> <span class="pre">'a';</span></code></p></li>
</ul>
<p>When using syntax option 1 we need separate function calls when the <code class="docutils literal notranslate"><span class="pre">path</span></code> is not identical. This query exemplifies how a user can use multiple queries with differing <code class="docutils literal notranslate"><span class="pre">path</span></code> values.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span> <span class="pre">FROM</span> <span class="pre">nested_objects</span> <span class="pre">WHERE</span> <span class="pre">nested(message,</span> <span class="pre">message.info</span> <span class="pre">=</span> <span class="pre">'a')</span> <span class="pre">OR</span> <span class="pre">nested(comment,</span> <span class="pre">comment.data</span> <span class="pre">=</span> <span class="pre">'123');</span></code></p></li>
</ul>
</section>
</section>
<section id="architecture-diagrams">
<h1>2 Architecture Diagrams<a class="headerlink" href="#architecture-diagrams" title="Link to this heading">¶</a></h1>
<section id="syntax-option-1-object-tree-to-dsl">
<h2>2.1 Syntax Option 1 Object Tree to DSL<a class="headerlink" href="#syntax-option-1-object-tree-to-dsl" title="Link to this heading">¶</a></h2>
<p>The following example illustrates the object tree that is built from the example query. This query’s object tree will impact the structure of the DSL to be pushed to OpenSearch.</p>
<p>Example Query: <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span>&#160; <span class="pre">FROM</span> <span class="pre">nested_objects</span> <span class="pre">WHERE</span> <span class="pre">nested(message,</span> <span class="pre">message.info</span> <span class="pre">=</span> <span class="pre">'a'</span> <span class="pre">OR</span> <span class="pre">message.info</span> <span class="pre">=</span> <span class="pre">'b'</span> <span class="pre">AND</span> <span class="pre">message.dayOfWeek</span> <span class="pre">&gt;</span> <span class="pre">4);</span></code></p>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span>graph TB;
    A[Function: NESTED\n&lt;hr&gt;arguments]--&gt;B1[ReferenceExpression:\nmessage]
    A--&gt;B2[Function: OR\n&lt;hr&gt;arguments]
    B2--&gt;C1[Function: =\n&lt;hr&gt;arguments]
    B2--&gt;C2[Function: AND\n&lt;hr&gt;arguments]
    
    C1--&gt;D1[ReferenceExpression:\nmessage.info]
    C1--&gt;D2[LiteralExpression:\na]
    
    C2--&gt;D3[Function: =\n&lt;hr&gt;arguments]
    C2--&gt;D4[Function: &gt;\n&lt;hr&gt;arguments]
    
    D3--&gt;E1[ReferenceExpression:\nmessage.info]
    D3--&gt;E2[LiteralExpression:\nb]
    D4--&gt;E3[ReferenceExpression:\nmessage.dayOfWeek]
    D4--&gt;E4[LiteralExpression:\n4]
</pre></div>
</div>
<section id="syntax-option-1-filter-push-down-sequence">
<h3>Syntax Option 1 Filter Push Down Sequence<a class="headerlink" href="#syntax-option-1-filter-push-down-sequence" title="Link to this heading">¶</a></h3>
<p>This diagram illustrates the steps the SQL plugin does to translate the object tree to DSL for execution in OpenSearch. Notice that the <code class="docutils literal notranslate"><span class="pre">nested</span></code> function forms the outer portion of the DSL query.</p>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span>stateDiagram-v2
  direction LR

  NestedNode --&gt; OrFuncNode
  OrFuncNode --&gt; OrFuncNode1
  OrFuncNode --&gt; OrFuncNode2
  OrFuncNode2 --&gt; AndFuncNode1
  OrFuncNode2 --&gt; AndFuncNode2

  state &quot;Function: NESTED&quot; as NestedNode {
    state &quot;visitFunction(NESTED)&quot; as NestedNodeVisitFunc
    state &quot;&#39;nested&#39;: {\n&amp;nbsp&#39;query&#39;: {\n...\n}}&quot; as NestedNodeDSL
    state &quot;visitFunction(condition)&quot; as NestedNodeVisitCondition

    NestedNodeVisitFunc --&gt; NestedNodeDSL
    NestedNodeVisitFunc --&gt; NestedNodeVisitCondition
  }

  state &quot;Function: OR&quot; as OrFuncNode {
    state &quot;visitFunction(OR)&quot; as OrFuncNodeVisitFunc
    state &quot;&#39;bool&#39;: {\n&amp;nbsp&#39;should&#39;: {\n...\n}}&quot; as OrFuncNodeDSL
    state &quot;arguments.accept()&quot; as OrFuncNodeArgs

    OrFuncNodeVisitFunc --&gt; OrFuncNodeDSL
    OrFuncNodeDSL --&gt; OrFuncNodeArgs
  }

  state &quot;Function: =&quot; as OrFuncNode1 {
    state &quot;visitFunction(=)&quot; as OrFuncNode1VisitFunc
    state &quot;&#39;term&#39;: {\n&amp;nbsp&#39;message.info&#39;: {\n&amp;nbsp&amp;nbsp&#39;value&#39;:&#39;a&#39;\n}}&quot; as OrFuncNode1DSL

    OrFuncNode1VisitFunc --&gt; OrFuncNode1DSL
  }

  state &quot;Function: AND&quot; as OrFuncNode2 {
    state &quot;visitFunction(AND)&quot; as OrFuncNode2VisitFunc
    state &quot;&#39;bool&#39;: {\n&amp;nbsp&#39;filter&#39;: {\n...\n}}&quot; as OrFuncNode2DSL
    state &quot;arguments.accept()&quot; as OrFuncNode2Args

    OrFuncNode2VisitFunc --&gt; OrFuncNode2DSL
    OrFuncNode2DSL --&gt; OrFuncNode2Args
  }

  state &quot;Function: =&quot; as AndFuncNode1 {
    state &quot;visitFunction(=)&quot; as AndFuncNode1VisitFunc
    state &quot;&#39;term&#39;: {\n&amp;nbsp&#39;message.info&#39;: {\n&amp;nbsp&amp;nbsp&#39;value&#39;:&#39;b&#39;\n}}&quot; as AndFuncNode1DSL

    AndFuncNode1VisitFunc --&gt; AndFuncNode1DSL
  }

  state &quot;Function: &gt;&quot; as AndFuncNode2 {
    state &quot;visitFunction(&gt;)&quot; as AndFuncNode2VisitFunc
    state &quot;&#39;range&#39;: {\n&amp;nbsp&#39;message.dayOfWeek&#39;: {\n&amp;nbsp&amp;nbsp&#39;from&#39;:4\n}}&quot; as AndFuncNode2DSL

    AndFuncNode2VisitFunc --&gt; AndFuncNode2DSL
  }
</pre></div>
</div>
</section>
<section id="syntax-option-1-output-query">
<h3>Syntax Option 1 Output Query<a class="headerlink" href="#syntax-option-1-output-query" title="Link to this heading">¶</a></h3>
<p>After pushing down the filter object tree we have a DSL query to push to OpenSearch. This query forms the boolean logic inside the <code class="docutils literal notranslate"><span class="pre">nested</span></code> query. This mirrors the syntax option chosen which has the condition specified inside the <code class="docutils literal notranslate"><span class="pre">nested</span></code> function.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;nested&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;query&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;bool&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;should&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;term&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;message.info&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;value&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;boost&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;bool&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;filter&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;term&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;message.info&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                      </span><span class="nt">&quot;value&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="nt">&quot;boost&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;range&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;message.dayOfWeek&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                      </span><span class="nt">&quot;from&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">                      </span><span class="err">...</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">              </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="syntax-option-2-object-tree-to-dsl">
<h2>2.2 Syntax option 2 Object Tree to DSL<a class="headerlink" href="#syntax-option-2-object-tree-to-dsl" title="Link to this heading">¶</a></h2>
<p>The following example illustrates the object tree that is built from the example query. Rather than have the boolean logic specified within the <code class="docutils literal notranslate"><span class="pre">nested</span></code> function, we have the <code class="docutils literal notranslate"><span class="pre">nested</span></code> function used in a predicate expression.</p>
<p>Example Query: <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span> <span class="pre">FROM</span> <span class="pre">nested_objects</span> <span class="pre">WHERE</span> <span class="pre">nested(message.info)</span> <span class="pre">=</span> <span class="pre">'a'</span> <span class="pre">OR</span> <span class="pre">nested(message.info)</span> <span class="pre">=</span> <span class="pre">'b'</span> <span class="pre">AND</span> <span class="pre">nested(message.dayOfWeek)</span> <span class="pre">&gt;</span> <span class="pre">4;</span></code></p>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span>graph TB;
    A[Function: OR\n&lt;hr&gt;arguments]--&gt;B1[Function: =\n&lt;hr&gt;arguments]
    A--&gt;B2[Function: AND\n&lt;hr&gt;arguments]
    
    B1--&gt;C1[Function: NESTED\n&lt;hr&gt;arguments]
    B1--&gt;C2[LiteralExpression:\na]
    
    B2--&gt;C3[Function: =\n&lt;hr&gt;arguments]
    B2--&gt;C4[Function: &gt;\n&lt;hr&gt;arguments]
    
    C1--&gt;D1[ReferenceExpression:\nmessage.info]
    C3--&gt;D2[Function: NESTED\n&lt;hr&gt;arguments]
    C3--&gt;D3[LiteralExpression:\nb]
    C4--&gt;D4[Function: NESTED\n&lt;hr&gt;arguments]
    C4--&gt;D5[LiteralExpression:\n4]
    
    D2--&gt;E1[ReferenceExpression:\nmessage.info]
    D4--&gt;E2[ReferenceExpression:\nmessage.dayOfWeek]
</pre></div>
</div>
<section id="syntax-option-2-filter-push-down-sequence">
<h3>Syntax Option 2 Filter Push Down Sequence<a class="headerlink" href="#syntax-option-2-filter-push-down-sequence" title="Link to this heading">¶</a></h3>
<p>This diagram illustrates the steps the SQL plugin goes through to translate the object tree to DSL for execution in OpenSearch. Notice that the boolean operations(<code class="docutils literal notranslate"><span class="pre">should/filter</span></code>) form the outer potion of the DSL query.</p>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span>stateDiagram-v2
  direction LR

  OrFuncNode --&gt; OrFuncNode1
  OrFuncNode --&gt; OrFuncNode2
  OrFuncNode2 --&gt; AndFuncNode1
  OrFuncNode2 --&gt; AndFuncNode2

  state &quot;Function: OR&quot; as OrFuncNode {
    state &quot;visitFunction(OR)&quot; as NestedNodeVisitFunc
    state &quot;&#39;bool&#39;: {\n&amp;nbsp&#39;should&#39;: {\n...\n}}&quot; as NestedNodeDSL
    state &quot;arguments.accept()&quot; as NestedNodeVisitCondition

    NestedNodeVisitFunc --&gt; NestedNodeDSL
    NestedNodeVisitFunc --&gt; NestedNodeVisitCondition
  }


  state &quot;Function: =&quot; as OrFuncNode1 {
    state &quot;visitFunction(=)&quot; as OrFuncNode1VisitFunc
    state &quot;&#39;nested&#39;: {\n&amp;nbsp&#39;query&#39;: {\n&amp;nbsp&amp;nbsp&amp;nbsp&#39;term&#39;\n&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&#39;message.info&#39;: {\n&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&#39;value&#39;: &#39;a&#39;,\n&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp}}}&quot; as OrFuncNode1DSL


    OrFuncNode1VisitFunc --&gt; OrFuncNode1DSL
  }


  state &quot;Function: AND&quot; as OrFuncNode2 {
    state &quot;visitFunction(AND)&quot; as OrFuncNode2VisitFunc
    state &quot;&#39;bool&#39;: {\n&amp;nbsp&#39;filter&#39;: {\n...\n}}&quot; as OrFuncNode2DSL
    state &quot;arguments.accept()&quot; as OrFuncNode2Args

    OrFuncNode2VisitFunc --&gt; OrFuncNode2DSL
    OrFuncNode2DSL --&gt; OrFuncNode2Args
  }

  state &quot;Function: =&quot; as AndFuncNode1 {
    state &quot;visitFunction(=)&quot; as AndFuncNode1VisitFunc
    state &quot;&#39;nested&#39;: {\n&amp;nbsp&#39;query&#39;: {\n&amp;nbsp&amp;nbsp&amp;nbsp&#39;term&#39;\n&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&#39;message.info&#39;: {\n&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&#39;value&#39;: &#39;b&#39;,\n&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp}}}&quot; as AndFuncNode1DSL

    AndFuncNode1VisitFunc --&gt; AndFuncNode1DSL
  }

  state &quot;Function: &gt;&quot; as AndFuncNode2 {
    state &quot;visitFunction(&gt;)&quot; as AndFuncNode2VisitFunc
    state &quot;&#39;nested&#39;: {\n&amp;nbsp&#39;query&#39;: {\n&amp;nbsp&amp;nbsp&amp;nbsp&#39;range&#39;\n&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&#39;message.dayOfWeek&#39;: {\n&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&#39;from&#39;: 4,\n&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp&amp;nbsp}}}&quot; as AndFuncNode2DSL

    AndFuncNode2VisitFunc --&gt; AndFuncNode2DSL
  }
</pre></div>
</div>
</section>
<section id="syntax-option-2-output-query">
<h3>Syntax Option 2 Output Query<a class="headerlink" href="#syntax-option-2-output-query" title="Link to this heading">¶</a></h3>
<p>After pushing down the filter object tree we have a DSL query to push to OpenSearch. This query forms the boolean logic as the outer portion of the query and has nested queries used inside. This mirrors the syntax option chosen which has the boolean operators forming a predicate expression with the <code class="docutils literal notranslate"><span class="pre">nested</span></code> functions in the SQL query.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;bool&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;should&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;nested&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;query&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;term&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;message.info&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;value&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;boost&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="err">...</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;bool&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;filter&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;nested&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;query&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;term&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;message.info&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                      </span><span class="nt">&quot;value&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="nt">&quot;boost&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="err">...</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;nested&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;query&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;range&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;message.dayOfWeek&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                      </span><span class="nt">&quot;from&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">                      </span><span class="err">...</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="err">...</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="additional-info">
<h1>Additional Info<a class="headerlink" href="#additional-info" title="Link to this heading">¶</a></h1>
<section id="demo-video">
<h2>Demo Video<a class="headerlink" href="#demo-video" title="Link to this heading">¶</a></h2>
<p>TBD</p>
</section>
<section id="normalizing-strategy">
<h2>Normalizing Strategy<a class="headerlink" href="#normalizing-strategy" title="Link to this heading">¶</a></h2>
<p>A normalization strategy could produce identical DSL independent on the syntax option used in the query. Testing so far hasn’t highlighted any major improvements with query execution that necessitate identical DSL. Additional benchmarking and planning will be done to determine a viable normalization strategy and if implementation is required.</p>
</section>
<section id="release-schedule">
<h2>Release Schedule<a class="headerlink" href="#release-schedule" title="Link to this heading">¶</a></h2>
<p>See Issues Tracked under <a class="reference external" href="https://github.com/opensearch-project/sql/issues/1111">Issue 1111</a> for related PR’s and information.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">sql-docs</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, josh.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../_sources/docs/dev/sql-nested-function-where-clause.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>