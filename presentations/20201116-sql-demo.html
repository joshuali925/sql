<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Agenda &#8212; Example 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=12dfc556" />
    <script src="../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="agenda">
<h1>Agenda<a class="headerlink" href="#agenda" title="Link to this heading">¶</a></h1>
<p>Presenter: Chen Dai</p>
<p>Contact info: https://www.linkedin.com/in/chen-dai/</p>
<p>Date: Nov 16, 2020</p>
<p>Topics:</p>
<ol class="arabic simple">
<li><p>A Brief Introduction to SQL and related projects</p></li>
<li><p>What’re already supported in the SQL engine</p></li>
<li><p>What’re new improvements in the SQL engine</p></li>
</ol>
<hr class="docutils" />
</section>
<section id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h1>
<p>Here is a great blog that covers main features of SQL, Query Workbench, SQL-CLI, JDBC/ODBC driver: https://opendistro.github.io/for-elasticsearch/blog/odfe-updates/2020/06/An-overview-of-the-SQL-Engine-in-Open-Distro-for-Elasticsearch/</p>
<p>Now we can start the demo. Note that you can follow the instructions in Resources (II) Demo Cluster to set up OpenSearch and OpenSearch Dashboards cluster locally.</p>
</section>
<section id="current-sql-engine">
<h1>Current SQL Engine<a class="headerlink" href="#current-sql-engine" title="Link to this heading">¶</a></h1>
<p>Demonstrate the support for basic SQL queries, complex queries and OpenSearch functions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Queries</span>
<span class="c1">##Basic query</span>
<span class="n">SELECT</span> <span class="n">Carrier</span><span class="p">,</span> <span class="n">AVG</span><span class="p">(</span><span class="n">FlightDelayMin</span><span class="p">)</span>
<span class="n">FROM</span> <span class="n">kibana_sample_data_flights</span>
<span class="n">WHERE</span> <span class="n">OriginWeather</span> <span class="o">=</span> <span class="s1">&#39;Sunny&#39;</span>
<span class="n">GROUP</span> <span class="n">BY</span> <span class="n">Carrier</span>
<span class="n">HAVING</span> <span class="n">AVG</span><span class="p">(</span><span class="n">FlightDelayMin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40</span>
<span class="n">ORDER</span> <span class="n">BY</span> <span class="n">Carrier</span>
<span class="n">LIMIT</span> <span class="mi">3</span>

<span class="c1">##Complex query</span>
<span class="n">SELECT</span> <span class="n">f1</span><span class="o">.</span><span class="n">FlightNum</span><span class="p">,</span> <span class="n">f2</span><span class="o">.</span><span class="n">Carrier</span>
<span class="n">FROM</span> <span class="n">kibana_sample_data_flights</span> <span class="n">f1</span>
<span class="n">JOIN</span> <span class="n">kibana_sample_data_flights</span> <span class="n">f2</span>
  <span class="n">ON</span> <span class="n">f1</span><span class="o">.</span><span class="n">FlightNum</span> <span class="o">=</span> <span class="n">f2</span><span class="o">.</span><span class="n">FlightNum</span>
<span class="n">WHERE</span> <span class="n">f1</span><span class="o">.</span><span class="n">OriginWeather</span> <span class="o">=</span> <span class="s1">&#39;Sunny&#39;</span>

<span class="c1">#OpenSearch</span>
<span class="c1">##Full text search</span>
<span class="n">SELECT</span> <span class="n">customer_full_name</span>
<span class="n">FROM</span> <span class="n">kibana_sample_data_ecommerce</span>
<span class="n">WHERE</span> <span class="n">MATCH_QUERY</span><span class="p">(</span><span class="n">customer_full_name</span><span class="p">,</span> <span class="s1">&#39;King&#39;</span><span class="p">)</span>

<span class="c1">##Nested field query</span>
<span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">employees</span> <span class="n">LIMIT</span> <span class="mi">10</span>

<span class="n">SELECT</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">started_year</span>
<span class="n">FROM</span> <span class="n">employees</span> <span class="n">e</span><span class="p">,</span>
    <span class="n">e</span><span class="o">.</span><span class="n">projects</span> <span class="n">p</span>
<span class="n">WHERE</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="n">LIKE</span> <span class="s1">&#39;%Redshift%&#39;</span>

</pre></div>
</div>
</section>
<section id="improvements-on-sql-engine">
<h1>Improvements on SQL Engine<a class="headerlink" href="#improvements-on-sql-engine" title="Link to this heading">¶</a></h1>
<p>Architecture changes: https://github.com/opendistro-for-elasticsearch/sql/blob/develop/docs/dev/Architecture.md</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#New query planner: explain this to see</span>
<span class="n">SELECT</span> <span class="n">Carrier</span><span class="p">,</span> <span class="n">AVG</span><span class="p">(</span><span class="n">FlightDelayMin</span><span class="p">)</span>
<span class="n">FROM</span> <span class="n">kibana_sample_data_flights</span>
<span class="n">WHERE</span> <span class="n">OriginWeather</span> <span class="o">=</span> <span class="s1">&#39;Sunny&#39;</span> 
<span class="n">GROUP</span> <span class="n">BY</span> <span class="n">Carrier</span>

<span class="c1">#Extensibility example: ranking window function</span>
<span class="n">SELECT</span>
    <span class="n">Carrier</span><span class="p">,</span> <span class="n">FlightDelayMin</span><span class="p">,</span>
    <span class="n">RANK</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">BY</span> <span class="n">Carrier</span>
    <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">FlightDelayMin</span> <span class="n">DESC</span>
    <span class="p">)</span> <span class="n">AS</span> <span class="n">rnk</span>
<span class="n">FROM</span> <span class="n">kibana_sample_data_flights</span>
<span class="n">WHERE</span> <span class="n">FlightDelayMin</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="c1">#New expression system</span>
<span class="n">SELECT</span>
  <span class="n">SUBSTRING</span><span class="p">(</span><span class="n">Carrier</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="n">AS</span> <span class="n">sub</span><span class="p">,</span>
  <span class="n">AVG</span><span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">FlightDelayMin</span> <span class="o">*</span> <span class="o">-</span><span class="mi">10</span><span class="p">))</span>
<span class="n">FROM</span> <span class="n">kibana_sample_data_flights</span>
<span class="n">WHERE</span> <span class="n">OriginWeather</span> <span class="o">=</span> <span class="s1">&#39;Sunny&#39;</span> 
<span class="n">GROUP</span> <span class="n">BY</span> <span class="n">sub</span>
</pre></div>
</div>
</section>
<section id="features-in-development">
<h1>Features in Development<a class="headerlink" href="#features-in-development" title="Link to this heading">¶</a></h1>
<ol class="arabic simple">
<li><p>SQL standard</p>
<ol class="arabic simple">
<li><p>SQL Functions</p></li>
<li><p>Complex queries: JOINs</p></li>
</ol>
</li>
<li><p>OpenSearch</p>
<ol class="arabic simple">
<li><p>More nested field support</p></li>
<li><p>More metrics and bucket functions</p></li>
</ol>
</li>
</ol>
<p>Contribution: https://github.com/opendistro-for-elasticsearch/sql/blob/develop/docs/developing.rst</p>
<hr class="docutils" />
</section>
<section id="resources">
<h1>Resources<a class="headerlink" href="#resources" title="Link to this heading">¶</a></h1>
<section id="i-documentations">
<h2>(I) Documentations<a class="headerlink" href="#i-documentations" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>SQL reference manual</p>
<ol class="arabic simple">
<li><p>https://opendistro.github.io/for-elasticsearch-docs/docs/sql/</p></li>
<li><p>https://github.com/opendistro-for-elasticsearch/sql/blob/develop/docs/user/index.rst</p></li>
</ol>
</li>
<li><p>Setting for enabling new SQL engine: https://github.com/opensearch-project/sql/blob/main/docs/user/admin/settings.rst#opendistrosqlenginenewenabled</p></li>
</ol>
</section>
<section id="ii-demo-cluster-setup">
<h2>(II) Demo Cluster Setup<a class="headerlink" href="#ii-demo-cluster-setup" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Create a Docker compose file as below</p></li>
<li><p>Start docker container: <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up</span></code></p></li>
<li><p>Visit OpenSearch Dashboards on http://localhost:5601 (default username and password are both <code class="docutils literal notranslate"><span class="pre">admin</span></code>)</p></li>
<li><p>Load OpenSearch Dashboards sample flights and ecommerce indices and <code class="docutils literal notranslate"><span class="pre">employees</span></code> test index as below</p></li>
<li><p>Start playing with our SQL plugin</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> sample:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">odfe</span><span class="o">-</span><span class="n">node1</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">amazon</span><span class="o">/</span><span class="n">opendistro</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="n">elasticsearch</span><span class="p">:</span><span class="mf">1.11.0</span>
    <span class="n">container_name</span><span class="p">:</span> <span class="n">odfe</span><span class="o">-</span><span class="n">node1</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">odfe</span><span class="o">-</span><span class="n">cluster</span>
      <span class="o">-</span> <span class="n">discovery</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">single</span><span class="o">-</span><span class="n">node</span>
      <span class="o">-</span> <span class="s2">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span> <span class="c1"># minimum and maximum Java heap size, recommend setting both to 50% of system RAM</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="mi">9200</span><span class="p">:</span><span class="mi">9200</span>
      <span class="o">-</span> <span class="mi">9600</span><span class="p">:</span><span class="mi">9600</span> <span class="c1"># required for Performance Analyzer</span>
    <span class="n">networks</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">odfe</span><span class="o">-</span><span class="n">net</span>
  <span class="n">kibana</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">amazon</span><span class="o">/</span><span class="n">opendistro</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">kibana</span><span class="p">:</span><span class="mf">1.11.0</span>
    <span class="n">container_name</span><span class="p">:</span> <span class="n">odfe</span><span class="o">-</span><span class="n">kibana</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="mi">5601</span><span class="p">:</span><span class="mi">5601</span>
    <span class="n">expose</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;5601&quot;</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="n">ELASTICSEARCH_URL</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">odfe</span><span class="o">-</span><span class="n">node1</span><span class="p">:</span><span class="mi">9200</span>
      <span class="n">ELASTICSEARCH_HOSTS</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">odfe</span><span class="o">-</span><span class="n">node1</span><span class="p">:</span><span class="mi">9200</span>
    <span class="n">networks</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">odfe</span><span class="o">-</span><span class="n">net</span>

<span class="n">networks</span><span class="p">:</span>
  <span class="n">odfe</span><span class="o">-</span><span class="n">net</span><span class="p">:</span>
</pre></div>
</div>
<p>Index mapping for <code class="docutils literal notranslate"><span class="pre">employees</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PUT</span> <span class="n">employees</span>
<span class="p">{</span>
  <span class="s2">&quot;mappings&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;long&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyword&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ignore_above&quot;</span><span class="p">:</span> <span class="mi">256</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="s2">&quot;projects&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;nested&quot;</span><span class="p">,</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyword&quot;</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;fielddata&quot;</span><span class="p">:</span> <span class="n">true</span>
          <span class="p">},</span>
          <span class="s2">&quot;started_year&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;long&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyword&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ignore_above&quot;</span><span class="p">:</span> <span class="mi">256</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">POST</span> <span class="n">employees</span><span class="o">/</span><span class="n">_bulk</span>
<span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Bob Smith&quot;</span><span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span><span class="n">null</span><span class="p">,</span><span class="s2">&quot;projects&quot;</span><span class="p">:[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;AWS Redshift Spectrum querying&quot;</span><span class="p">,</span><span class="s2">&quot;started_year&quot;</span><span class="p">:</span><span class="mi">1990</span><span class="p">},{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;AWS Redshift security&quot;</span><span class="p">,</span><span class="s2">&quot;started_year&quot;</span><span class="p">:</span><span class="mi">1999</span><span class="p">},{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;AWS Aurora security&quot;</span><span class="p">,</span><span class="s2">&quot;started_year&quot;</span><span class="p">:</span><span class="mi">2015</span><span class="p">}]}</span>
<span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;2&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Susan Smith&quot;</span><span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Dev Mgr&quot;</span><span class="p">,</span><span class="s2">&quot;projects&quot;</span><span class="p">:[]}</span>
<span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;3&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Jane Smith&quot;</span><span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;Software Eng 2&quot;</span><span class="p">,</span><span class="s2">&quot;projects&quot;</span><span class="p">:[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;AWS Redshift security&quot;</span><span class="p">,</span><span class="s2">&quot;started_year&quot;</span><span class="p">:</span><span class="mi">1998</span><span class="p">},{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;AWS Hello security&quot;</span><span class="p">,</span><span class="s2">&quot;started_year&quot;</span><span class="p">:</span><span class="mi">2015</span><span class="p">,</span><span class="s2">&quot;address&quot;</span><span class="p">:[{</span><span class="s2">&quot;city&quot;</span><span class="p">:</span><span class="s2">&quot;Dallas&quot;</span><span class="p">,</span><span class="s2">&quot;state&quot;</span><span class="p">:</span><span class="s2">&quot;TX&quot;</span><span class="p">}]}]}</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Example</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;workshop participant.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../_sources/presentations/20201116-sql-demo.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>