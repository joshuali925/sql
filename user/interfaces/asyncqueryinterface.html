<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Async Query Interface Endpoints &#8212; Example 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="async-query-interface-endpoints">
<h1>Async Query Interface Endpoints<a class="headerlink" href="#async-query-interface-endpoints" title="Link to this heading">¶</a></h1>
<p class="rubric">Table of contents</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#required-spark-execution-engine-config-for-async-query-apis" id="id2">Required Spark Execution Engine Config for Async Query APIs</a></p></li>
<li><p><a class="reference internal" href="#async-query-creation-api" id="id3">Async Query Creation API</a></p></li>
<li><p><a class="reference internal" href="#async-query-result-api" id="id4">Async Query Result API</a></p></li>
<li><p><a class="reference internal" href="#async-query-cancellation-api" id="id5">Async Query Cancellation API</a></p></li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>For supporting <a class="reference external" href="../ppl/admin/connectors/s3glue_connector.rst">S3Glue</a>  datasource connector, we have introduced a new execution engine on top of Spark.
All the queries to be executed on spark execution engine can only be submitted via Async Query APIs. Below sections will list all the new APIs introduced.</p>
</section>
<section id="required-spark-execution-engine-config-for-async-query-apis">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Required Spark Execution Engine Config for Async Query APIs</a><a class="headerlink" href="#required-spark-execution-engine-config-for-async-query-apis" title="Link to this heading">¶</a></h2>
<p>Currently, the system supports only AWS EMRServerless as the SPARK execution engine. Configuration details for the execution engine should be specified under <code class="docutils literal notranslate"><span class="pre">plugins.query.executionengine.spark.config</span></code> in the opensearch.yml or cluster settings. The configuration value is expected to be a JSON string that includes <code class="docutils literal notranslate"><span class="pre">applicationId</span></code>, <code class="docutils literal notranslate"><span class="pre">executionRoleARN</span></code>, <code class="docutils literal notranslate"><span class="pre">region</span></code>, and <code class="docutils literal notranslate"><span class="pre">sparkSubmitParameter</span></code>.</p>
<section id="sample-setting-value-in-opensearch-yml">
<h3>Sample Setting Value in opensearch.yml<a class="headerlink" href="#sample-setting-value-in-opensearch-yml" title="Link to this heading">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;plugins.query.executionengine.spark.config:</span><span class="nv"> </span><span class="s">&#39;{\&quot;applicationId\&quot;:\&quot;xxxxx\&quot;,\&quot;executionRoleARN\&quot;:\&quot;arn:aws:iam::xxxxx:role/emr-job-execution-role\&quot;,\&quot;region\&quot;:\&quot;us-west-2\&quot;,</span><span class="nv"> </span><span class="s">\&quot;sparkSubmitParameters\&quot;:</span><span class="nv"> </span><span class="s">\&quot;--conf</span><span class="nv"> </span><span class="s">spark.dynamicAllocation.enabled=false\&quot;}&#39;&quot;</span>
</pre></div>
</div>
</section>
<section id="caution">
<h3>Caution<a class="headerlink" href="#caution" title="Link to this heading">¶</a></h3>
<p>Users must exercise caution when transitioning to a new application or region, as changes to these parameters may lead to failures in retrieving results from previous asynchronous query jobs.</p>
<p>The system utilizes the default AWS credentials chain for calls to the EMR serverless application. It is critical to ensure that the default credentials have the necessary permissions to assume the role required for EMR job execution, as delineated in the engine configuration.</p>
</section>
<section id="requirements">
<h3>Requirements<a class="headerlink" href="#requirements" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>Required Parameters</strong>: <code class="docutils literal notranslate"><span class="pre">applicationId</span></code>, <code class="docutils literal notranslate"><span class="pre">executionRoleARN</span></code>, and <code class="docutils literal notranslate"><span class="pre">region</span></code> must be provided.</p></li>
<li><p><strong>Optional Parameter</strong>: <code class="docutils literal notranslate"><span class="pre">sparkSubmitParameter</span></code> is optional and can be formatted as <code class="docutils literal notranslate"><span class="pre">--conf</span> <span class="pre">A=1</span> <span class="pre">--conf</span> <span class="pre">B=2</span> <span class="pre">...</span></code>.</p></li>
</ul>
</section>
<section id="aws-cloudwatch-metrics-configuration">
<h3>AWS CloudWatch metrics configuration<a class="headerlink" href="#aws-cloudwatch-metrics-configuration" title="Link to this heading">¶</a></h3>
<p>Starting with Flint 0.1.1, users can utilize AWS CloudWatch as an external metrics sink while configuring their own metric sources. Below is an example of a console request for setting this up:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="err">PUT</span><span class="w"> </span><span class="err">_clus</span><span class="kc">ter</span><span class="err">/se</span><span class="kc">tt</span><span class="err">i</span><span class="kc">n</span><span class="err">gs</span>
<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;persistent&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;plugins.query.executionengine.spark.config&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;applicationId\&quot;:\&quot;xxxxx\&quot;,\&quot;executionRoleARN\&quot;:\&quot;arn:aws:iam::xxxxx:role/emr-job-execution-role\&quot;,\&quot;region\&quot;:\&quot;us-east-1\&quot;,\&quot;sparkSubmitParameters\&quot;:\&quot;--conf spark.dynamicAllocation.enabled=false --conf spark.metrics.conf.*.sink.cloudwatch.class=org.apache.spark.metrics.sink.CloudWatchSink --conf spark.metrics.conf.*.sink.cloudwatch.namespace=OpenSearchSQLSpark --conf spark.metrics.conf.*.sink.cloudwatch.regex=(opensearch|numberAllExecutors).* --conf spark.metrics.conf.*.source.cloudwatch.class=org.apache.spark.metrics.source.FlintMetricSource \&quot;}&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For a comprehensive list of Spark configuration options related to metrics, please refer to the Spark documentation on monitoring:</p>
<ul class="simple">
<li><p>Spark Monitoring Documentation: <a class="reference external" href="https://spark.apache.org/docs/latest/monitoring.html#metrics">https://spark.apache.org/docs/latest/monitoring.html#metrics</a></p></li>
</ul>
<p>Additionally, for details on setting up CloudWatch metric sink and Flint metric source, consult the OpenSearch Spark project:</p>
<ul class="simple">
<li><p>OpenSearch Spark GitHub Repository: <a class="reference external" href="https://github.com/opensearch-project/opensearch-spark">https://github.com/opensearch-project/opensearch-spark</a></p></li>
</ul>
</section>
</section>
<section id="async-query-creation-api">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Async Query Creation API</a><a class="headerlink" href="#async-query-creation-api" title="Link to this heading">¶</a></h2>
<p>If security plugin is enabled, this API can only be invoked by users with permission <code class="docutils literal notranslate"><span class="pre">cluster:admin/opensearch/ql/async_query/create</span></code>.</p>
<p>HTTP URI: <code class="docutils literal notranslate"><span class="pre">_plugins/_async_query</span></code></p>
<p>HTTP VERB: <code class="docutils literal notranslate"><span class="pre">POST</span></code></p>
<p>Sample Request:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>--location<span class="w"> </span><span class="s1">&#39;http://localhost:9200/_plugins/_async_query&#39;</span><span class="w"> </span><span class="se">\</span>
--header<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
--data<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;datasource&quot; : &quot;my_glue&quot;,</span>
<span class="s1">    &quot;lang&quot; : &quot;sql&quot;,</span>
<span class="s1">    &quot;query&quot; : &quot;select * from my_glue.default.http_logs limit 10&quot;</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<p>Sample Response:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;queryId&quot;</span>:<span class="w"> </span><span class="s2">&quot;00fd796ut1a7eg0q&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<section id="execute-query-in-session">
<h3>Execute query in session<a class="headerlink" href="#execute-query-in-session" title="Link to this heading">¶</a></h3>
<p>if plugins.query.executionengine.spark.session.enabled is set to true, session based execution is enabled. Under the hood, all queries submitted to the same session will be executed in the same SparkContext. Session is auto closed if not query submission in 10 minutes.</p>
<p>Async query response include <code class="docutils literal notranslate"><span class="pre">sessionId</span></code> indicate the query is executed in session.</p>
<p>Sample Request:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>--location<span class="w"> </span><span class="s1">&#39;http://localhost:9200/_plugins/_async_query&#39;</span><span class="w"> </span><span class="se">\</span>
--header<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
--data<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;datasource&quot; : &quot;my_glue&quot;,</span>
<span class="s1">    &quot;lang&quot; : &quot;sql&quot;,</span>
<span class="s1">    &quot;query&quot; : &quot;select * from my_glue.default.http_logs limit 10&quot;</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<p>Sample Response:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;queryId&quot;</span>:<span class="w"> </span><span class="s2">&quot;HlbM61kX6MDkAktO&quot;</span>,
<span class="w">  </span><span class="s2">&quot;sessionId&quot;</span>:<span class="w"> </span><span class="s2">&quot;1Giy65ZnzNlmsPAm&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>User could reuse the session by using <code class="docutils literal notranslate"><span class="pre">sessionId</span></code> query parameters.</p>
<p>Sample Request:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>--location<span class="w"> </span><span class="s1">&#39;http://localhost:9200/_plugins/_async_query&#39;</span><span class="w"> </span><span class="se">\</span>
--header<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
--data<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;datasource&quot; : &quot;my_glue&quot;,</span>
<span class="s1">    &quot;lang&quot; : &quot;sql&quot;,</span>
<span class="s1">    &quot;query&quot; : &quot;select * from my_glue.default.http_logs limit 10&quot;,</span>
<span class="s1">    &quot;sessionId&quot; : &quot;1Giy65ZnzNlmsPAm&quot;</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<p>Sample Response:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;queryId&quot;</span>:<span class="w"> </span><span class="s2">&quot;7GC4mHhftiTejvxN&quot;</span>,
<span class="w">  </span><span class="s2">&quot;sessionId&quot;</span>:<span class="w"> </span><span class="s2">&quot;1Giy65ZnzNlmsPAm&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
</section>
<section id="async-query-result-api">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Async Query Result API</a><a class="headerlink" href="#async-query-result-api" title="Link to this heading">¶</a></h2>
<p>If security plugin is enabled, this API can only be invoked by users with permission <code class="docutils literal notranslate"><span class="pre">cluster:admin/opensearch/ql/async_query/result</span></code>.
Async Query Creation and Result Query permissions are orthogonal, so any user with result api permissions and queryId can query the corresponding query results irrespective of the user who created the async query.</p>
<p>HTTP URI: <code class="docutils literal notranslate"><span class="pre">_plugins/_async_query/{queryId}</span></code></p>
<p>HTTP VERB: <code class="docutils literal notranslate"><span class="pre">GET</span></code></p>
<p>Sample Request BODY:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>--location<span class="w"> </span>--request<span class="w"> </span>GET<span class="w"> </span><span class="s1">&#39;http://localhost:9200/_plugins/_async_query/00fd796ut1a7eg0q&#39;</span><span class="w"> </span><span class="se">\</span>
--header<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<p>Sample Response if the Query is in Progress</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">{</span><span class="s2">&quot;status&quot;</span>:<span class="s2">&quot;RUNNING&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>Sample Response If the Query is successful</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;status&quot;</span>:<span class="w"> </span><span class="s2">&quot;SUCCESS&quot;</span>,
<span class="w">    </span><span class="s2">&quot;schema&quot;</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;indexed_col_name&quot;</span>,
<span class="w">            </span><span class="s2">&quot;type&quot;</span>:<span class="w"> </span><span class="s2">&quot;string&quot;</span>
<span class="w">        </span><span class="o">}</span>,
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;data_type&quot;</span>,
<span class="w">            </span><span class="s2">&quot;type&quot;</span>:<span class="w"> </span><span class="s2">&quot;string&quot;</span>
<span class="w">        </span><span class="o">}</span>,
<span class="w">        </span><span class="o">{</span>
<span class="w">            </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;skip_type&quot;</span>,
<span class="w">            </span><span class="s2">&quot;type&quot;</span>:<span class="w"> </span><span class="s2">&quot;string&quot;</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">    </span><span class="o">]</span>,
<span class="w">    </span><span class="s2">&quot;datarows&quot;</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="o">[</span>
<span class="w">            </span><span class="s2">&quot;status&quot;</span>,
<span class="w">            </span><span class="s2">&quot;int&quot;</span>,
<span class="w">            </span><span class="s2">&quot;VALUE_SET&quot;</span>
<span class="w">        </span><span class="o">]</span>
<span class="w">    </span><span class="o">]</span>,
<span class="w">    </span><span class="s2">&quot;total&quot;</span>:<span class="w"> </span><span class="m">1</span>,
<span class="w">    </span><span class="s2">&quot;size&quot;</span>:<span class="w"> </span><span class="m">1</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="async-query-cancellation-api">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Async Query Cancellation API</a><a class="headerlink" href="#async-query-cancellation-api" title="Link to this heading">¶</a></h2>
<p>If security plugin is enabled, this API can only be invoked by users with permission <code class="docutils literal notranslate"><span class="pre">cluster:admin/opensearch/ql/jobs/delete</span></code>.</p>
<p>Limitation: Flint index creation statement with auto_refresh = true can not be cancelled. User could submit ALTER statement to stop auto refresh query.
- flint index creation statement include, CREATE SKIPPING INDEX / CREATE INDEX / CREATE MATERIALIZED VIEW</p>
<p>HTTP URI: <code class="docutils literal notranslate"><span class="pre">_plugins/_async_query/{queryId}</span></code></p>
<p>HTTP VERB: <code class="docutils literal notranslate"><span class="pre">DELETE</span></code></p>
<p>Sample Request Body</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>--location<span class="w"> </span>--request<span class="w"> </span>DELETE<span class="w"> </span><span class="s1">&#39;http://localhost:9200/_plugins/_async_query/00fdalrvgkbh2g0q&#39;</span><span class="w"> </span><span class="se">\</span>
--header<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Example</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;workshop participant.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../_sources/user/interfaces/asyncqueryinterface.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>