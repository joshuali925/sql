<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Optimizations &#8212; Example 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="optimizations">
<h1>Optimizations<a class="headerlink" href="#optimizations" title="Link to this heading">¶</a></h1>
<p class="rubric">Table of contents</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#logical-plan-optimization" id="id2">Logical Plan Optimization</a></p>
<ul>
<li><p><a class="reference internal" href="#where-clause-optimization" id="id3">Where Clause Optimization</a></p></li>
<li><p><a class="reference internal" href="#filter-merge-rule" id="id4">Filter Merge Rule</a></p></li>
<li><p><a class="reference internal" href="#filter-push-down-under-sort" id="id5">Filter Push Down Under Sort</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#opensearch-specific-optimization" id="id6">OpenSearch Specific Optimization</a></p>
<ul>
<li><p><a class="reference internal" href="#push-project-into-query-dsl" id="id7">Push Project Into Query DSL</a></p></li>
<li><p><a class="reference internal" href="#filter-merge-into-query-dsl" id="id8">Filter Merge Into Query DSL</a></p></li>
<li><p><a class="reference internal" href="#sort-merge-into-query-dsl" id="id9">Sort Merge Into Query DSL</a></p></li>
<li><p><a class="reference internal" href="#limit-merge-into-query-dsl" id="id10">Limit Merge Into Query DSL</a></p></li>
<li><p><a class="reference internal" href="#aggregation-merge-into-opensearch-aggregation" id="id11">Aggregation Merge Into OpenSearch Aggregation</a></p></li>
<li><p><a class="reference internal" href="#sort-merge-into-opensearch-aggregation" id="id12">Sort Merge Into OpenSearch Aggregation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#limitations-on-query-optimizations" id="id13">Limitations on Query Optimizations</a></p>
<ul>
<li><p><a class="reference internal" href="#multi-fields-in-where-conditions" id="id14">Multi-fields in WHERE Conditions</a></p></li>
<li><p><a class="reference internal" href="#multiple-window-functions" id="id15">Multiple Window Functions</a></p></li>
<li><p><a class="reference internal" href="#sort-push-down" id="id16">Sort Push Down</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>In this doc, we will cover the optimization solution in the query engine and the limitations.</p>
</section>
<section id="logical-plan-optimization">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Logical Plan Optimization</a><a class="headerlink" href="#logical-plan-optimization" title="Link to this heading">¶</a></h2>
<p>The Logical Plan optimization transfer the logical operator by predefined rules. The following section will cover the detail rules.</p>
<section id="where-clause-optimization">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Where Clause Optimization</a><a class="headerlink" href="#where-clause-optimization" title="Link to this heading">¶</a></h3>
<p>The where clause will reduce the size of rows markedly, thus the where clause optimization is the most important optimization.</p>
<p>There are two rules involved in the core engine.</p>
</section>
<section id="filter-merge-rule">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Filter Merge Rule</a><a class="headerlink" href="#filter-merge-rule" title="Link to this heading">¶</a></h3>
<p>The consecutive Filter operator will be merged as one Filter operator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_ppl/_explain \
... -d &#39;{&quot;query&quot; : &quot;source=accounts | where age &gt; 10 | where age &lt; 20 | fields age&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[age]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
        &quot;description&quot;: {
          &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:0,\&quot;size\&quot;:200,\&quot;timeout\&quot;:\&quot;1m\&quot;,\&quot;query\&quot;:{\&quot;bool\&quot;:{\&quot;filter\&quot;:[{\&quot;range\&quot;:{\&quot;age\&quot;:{\&quot;from\&quot;:null,\&quot;to\&quot;:20,\&quot;include_lower\&quot;:true,\&quot;include_upper\&quot;:false,\&quot;boost\&quot;:1.0}}},{\&quot;range\&quot;:{\&quot;age\&quot;:{\&quot;from\&quot;:10,\&quot;to\&quot;:null,\&quot;include_lower\&quot;:false,\&quot;include_upper\&quot;:true,\&quot;boost\&quot;:1.0}}}],\&quot;adjust_pure_negative\&quot;:true,\&quot;boost\&quot;:1.0}},\&quot;_source\&quot;:{\&quot;includes\&quot;:[\&quot;age\&quot;],\&quot;excludes\&quot;:[]},\&quot;sort\&quot;:[{\&quot;_doc\&quot;:{\&quot;order\&quot;:\&quot;asc\&quot;}}]}, searchDone=false)&quot;
        },
        &quot;children&quot;: []
      }
    ]
  }
}
</pre></div>
</div>
</section>
<section id="filter-push-down-under-sort">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Filter Push Down Under Sort</a><a class="headerlink" href="#filter-push-down-under-sort" title="Link to this heading">¶</a></h3>
<p>The Filter operator should be push down under Sort operator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_ppl/_explain \
... -d &#39;{&quot;query&quot; : &quot;source=accounts | sort age | where age &lt; 20 | fields age&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[age]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
        &quot;description&quot;: {
          &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:0,\&quot;size\&quot;:200,\&quot;timeout\&quot;:\&quot;1m\&quot;,\&quot;query\&quot;:{\&quot;range\&quot;:{\&quot;age\&quot;:{\&quot;from\&quot;:null,\&quot;to\&quot;:20,\&quot;include_lower\&quot;:true,\&quot;include_upper\&quot;:false,\&quot;boost\&quot;:1.0}}},\&quot;_source\&quot;:{\&quot;includes\&quot;:[\&quot;age\&quot;],\&quot;excludes\&quot;:[]},\&quot;sort\&quot;:[{\&quot;age\&quot;:{\&quot;order\&quot;:\&quot;asc\&quot;,\&quot;missing\&quot;:\&quot;_first\&quot;}}]}, searchDone=false)&quot;
        },
        &quot;children&quot;: []
      }
    ]
  }
}
</pre></div>
</div>
</section>
</section>
<section id="opensearch-specific-optimization">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">OpenSearch Specific Optimization</a><a class="headerlink" href="#opensearch-specific-optimization" title="Link to this heading">¶</a></h2>
<p>The OpenSearch <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html">Query DSL</a> and <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">Aggregation</a> also enabling the storage engine specific optimization.</p>
<section id="push-project-into-query-dsl">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Push Project Into Query DSL</a><a class="headerlink" href="#push-project-into-query-dsl" title="Link to this heading">¶</a></h3>
<p>The Project list will push down to Query DSL to <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/search-fields.html#source-filtering">filter the source</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_sql/_explain \
... -d &#39;{&quot;query&quot; : &quot;SELECT age FROM accounts&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[age]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
        &quot;description&quot;: {
          &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:0,\&quot;size\&quot;:200,\&quot;timeout\&quot;:\&quot;1m\&quot;,\&quot;_source\&quot;:{\&quot;includes\&quot;:[\&quot;age\&quot;],\&quot;excludes\&quot;:[]}}, searchDone=false)&quot;
        },
        &quot;children&quot;: []
      }
    ]
  }
}
</pre></div>
</div>
</section>
<section id="filter-merge-into-query-dsl">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Filter Merge Into Query DSL</a><a class="headerlink" href="#filter-merge-into-query-dsl" title="Link to this heading">¶</a></h3>
<p>The Filter operator will merge into OpenSearch Query DSL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_sql/_explain \
... -d &#39;{&quot;query&quot; : &quot;SELECT age FROM accounts WHERE age &gt; 30&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[age]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
        &quot;description&quot;: {
          &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:0,\&quot;size\&quot;:200,\&quot;timeout\&quot;:\&quot;1m\&quot;,\&quot;query\&quot;:{\&quot;range\&quot;:{\&quot;age\&quot;:{\&quot;from\&quot;:30,\&quot;to\&quot;:null,\&quot;include_lower\&quot;:false,\&quot;include_upper\&quot;:true,\&quot;boost\&quot;:1.0}}},\&quot;_source\&quot;:{\&quot;includes\&quot;:[\&quot;age\&quot;],\&quot;excludes\&quot;:[]},\&quot;sort\&quot;:[{\&quot;_doc\&quot;:{\&quot;order\&quot;:\&quot;asc\&quot;}}]}, searchDone=false)&quot;
        },
        &quot;children&quot;: []
      }
    ]
  }
}
</pre></div>
</div>
</section>
<section id="sort-merge-into-query-dsl">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Sort Merge Into Query DSL</a><a class="headerlink" href="#sort-merge-into-query-dsl" title="Link to this heading">¶</a></h3>
<p>The Sort operator will merge into OpenSearch Query DSL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_sql/_explain \
... -d &#39;{&quot;query&quot; : &quot;SELECT age FROM accounts ORDER BY age&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[age]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
        &quot;description&quot;: {
          &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:0,\&quot;size\&quot;:200,\&quot;timeout\&quot;:\&quot;1m\&quot;,\&quot;_source\&quot;:{\&quot;includes\&quot;:[\&quot;age\&quot;],\&quot;excludes\&quot;:[]},\&quot;sort\&quot;:[{\&quot;age\&quot;:{\&quot;order\&quot;:\&quot;asc\&quot;,\&quot;missing\&quot;:\&quot;_first\&quot;}}]}, searchDone=false)&quot;
        },
        &quot;children&quot;: []
      }
    ]
  }
}
</pre></div>
</div>
<p>Because the OpenSearch Script Based Sorting can’t handle NULL/MISSING value, there is one exception is that if the sort list include expression other than field reference, it will not be merged into Query DSL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_sql/_explain \
... -d &#39;{&quot;query&quot; : &quot;SELECT age FROM accounts ORDER BY abs(age)&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[age]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;SortOperator&quot;,
        &quot;description&quot;: {
          &quot;sortList&quot;: {
            &quot;abs(age)&quot;: {
              &quot;sortOrder&quot;: &quot;ASC&quot;,
              &quot;nullOrder&quot;: &quot;NULL_FIRST&quot;
            }
          }
        },
        &quot;children&quot;: [
          {
            &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
            &quot;description&quot;: {
              &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:0,\&quot;size\&quot;:200,\&quot;timeout\&quot;:\&quot;1m\&quot;}, searchDone=false)&quot;
            },
            &quot;children&quot;: []
          }
        ]
      }
    ]
  }
}
</pre></div>
</div>
</section>
<section id="limit-merge-into-query-dsl">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Limit Merge Into Query DSL</a><a class="headerlink" href="#limit-merge-into-query-dsl" title="Link to this heading">¶</a></h3>
<p>The Limit operator will merge in OpenSearch Query DSL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_sql/_explain \
... -d &#39;{&quot;query&quot; : &quot;SELECT age FROM accounts LIMIT 10 OFFSET 5&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[age]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
        &quot;description&quot;: {
          &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:5,\&quot;size\&quot;:10,\&quot;timeout\&quot;:\&quot;1m\&quot;,\&quot;_source\&quot;:{\&quot;includes\&quot;:[\&quot;age\&quot;],\&quot;excludes\&quot;:[]}}, searchDone=false)&quot;
        },
        &quot;children&quot;: []
      }
    ]
  }
}
</pre></div>
</div>
<p>If sort that includes expression, which cannot be merged into query DSL, also exists in the query, the Limit operator will not be merged into query DSL as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_sql/_explain \
... -d &#39;{&quot;query&quot; : &quot;SELECT age FROM accounts ORDER BY abs(age) LIMIT 10&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[age]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;LimitOperator&quot;,
        &quot;description&quot;: {
          &quot;limit&quot;: 10,
          &quot;offset&quot;: 0
        },
        &quot;children&quot;: [
          {
            &quot;name&quot;: &quot;SortOperator&quot;,
            &quot;description&quot;: {
              &quot;sortList&quot;: {
                &quot;abs(age)&quot;: {
                  &quot;sortOrder&quot;: &quot;ASC&quot;,
                  &quot;nullOrder&quot;: &quot;NULL_FIRST&quot;
                }
              }
            },
            &quot;children&quot;: [
              {
                &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
                &quot;description&quot;: {
                  &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:0,\&quot;size\&quot;:200,\&quot;timeout\&quot;:\&quot;1m\&quot;}, searchDone=false)&quot;
                },
                &quot;children&quot;: []
              }
            ]
          }
        ]
      }
    ]
  }
}
</pre></div>
</div>
</section>
<section id="aggregation-merge-into-opensearch-aggregation">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Aggregation Merge Into OpenSearch Aggregation</a><a class="headerlink" href="#aggregation-merge-into-opensearch-aggregation" title="Link to this heading">¶</a></h3>
<p>The Aggregation operator will merge into OpenSearch Aggregation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_sql/_explain \
... -d &#39;{&quot;query&quot; : &quot;SELECT gender, avg(age) FROM accounts GROUP BY gender&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[gender, avg(age)]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
        &quot;description&quot;: {
          &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:0,\&quot;size\&quot;:200,\&quot;timeout\&quot;:\&quot;1m\&quot;,\&quot;aggregations\&quot;:{\&quot;composite_buckets\&quot;:{\&quot;composite\&quot;:{\&quot;size\&quot;:1000,\&quot;sources\&quot;:[{\&quot;gender\&quot;:{\&quot;terms\&quot;:{\&quot;field\&quot;:\&quot;gender.keyword\&quot;,\&quot;missing_bucket\&quot;:true,\&quot;missing_order\&quot;:\&quot;first\&quot;,\&quot;order\&quot;:\&quot;asc\&quot;}}}]},\&quot;aggregations\&quot;:{\&quot;avg(age)\&quot;:{\&quot;avg\&quot;:{\&quot;field\&quot;:\&quot;age\&quot;}}}}}}, searchDone=false)&quot;
        },
        &quot;children&quot;: []
      }
    ]
  }
}
</pre></div>
</div>
</section>
<section id="sort-merge-into-opensearch-aggregation">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Sort Merge Into OpenSearch Aggregation</a><a class="headerlink" href="#sort-merge-into-opensearch-aggregation" title="Link to this heading">¶</a></h3>
<p>The Sort operator will merge into OpenSearch Aggregation.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_sql/_explain \
... -d &#39;{&quot;query&quot; : &quot;SELECT gender, avg(age) FROM accounts GROUP BY gender ORDER BY gender DESC NULLS LAST&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[gender, avg(age)]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
        &quot;description&quot;: {
          &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:0,\&quot;size\&quot;:200,\&quot;timeout\&quot;:\&quot;1m\&quot;,\&quot;aggregations\&quot;:{\&quot;composite_buckets\&quot;:{\&quot;composite\&quot;:{\&quot;size\&quot;:1000,\&quot;sources\&quot;:[{\&quot;gender\&quot;:{\&quot;terms\&quot;:{\&quot;field\&quot;:\&quot;gender.keyword\&quot;,\&quot;missing_bucket\&quot;:true,\&quot;missing_order\&quot;:\&quot;last\&quot;,\&quot;order\&quot;:\&quot;desc\&quot;}}}]},\&quot;aggregations\&quot;:{\&quot;avg(age)\&quot;:{\&quot;avg\&quot;:{\&quot;field\&quot;:\&quot;age\&quot;}}}}}}, searchDone=false)&quot;
        },
        &quot;children&quot;: []
      }
    ]
  }
}
</pre></div>
</div>
<p>Because the OpenSearch Composite Aggregation doesn’t support order by metrics field, then if the sort list include fields which refer to metrics aggregation, then the sort operator can’t be push down to OpenSearch Aggregation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh$ curl -sS -H &#39;Content-Type: application/json&#39; \
... -X POST localhost:9200/_plugins/_sql/_explain \
... -d &#39;{&quot;query&quot; : &quot;SELECT gender, avg(age) FROM accounts GROUP BY gender ORDER BY avg(age)&quot;}&#39;
{
  &quot;root&quot;: {
    &quot;name&quot;: &quot;ProjectOperator&quot;,
    &quot;description&quot;: {
      &quot;fields&quot;: &quot;[gender, avg(age)]&quot;
    },
    &quot;children&quot;: [
      {
        &quot;name&quot;: &quot;SortOperator&quot;,
        &quot;description&quot;: {
          &quot;sortList&quot;: {
            &quot;avg(age)&quot;: {
              &quot;sortOrder&quot;: &quot;ASC&quot;,
              &quot;nullOrder&quot;: &quot;NULL_FIRST&quot;
            }
          }
        },
        &quot;children&quot;: [
          {
            &quot;name&quot;: &quot;OpenSearchIndexScan&quot;,
            &quot;description&quot;: {
              &quot;request&quot;: &quot;OpenSearchQueryRequest(indexName=accounts, sourceBuilder={\&quot;from\&quot;:0,\&quot;size\&quot;:200,\&quot;timeout\&quot;:\&quot;1m\&quot;,\&quot;aggregations\&quot;:{\&quot;composite_buckets\&quot;:{\&quot;composite\&quot;:{\&quot;size\&quot;:1000,\&quot;sources\&quot;:[{\&quot;gender\&quot;:{\&quot;terms\&quot;:{\&quot;field\&quot;:\&quot;gender.keyword\&quot;,\&quot;missing_bucket\&quot;:true,\&quot;missing_order\&quot;:\&quot;first\&quot;,\&quot;order\&quot;:\&quot;asc\&quot;}}}]},\&quot;aggregations\&quot;:{\&quot;avg(age)\&quot;:{\&quot;avg\&quot;:{\&quot;field\&quot;:\&quot;age\&quot;}}}}}}, searchDone=false)&quot;
            },
            &quot;children&quot;: []
          }
        ]
      }
    ]
  }
}
</pre></div>
</div>
</section>
</section>
<section id="limitations-on-query-optimizations">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Limitations on Query Optimizations</a><a class="headerlink" href="#limitations-on-query-optimizations" title="Link to this heading">¶</a></h2>
<section id="multi-fields-in-where-conditions">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Multi-fields in WHERE Conditions</a><a class="headerlink" href="#multi-fields-in-where-conditions" title="Link to this heading">¶</a></h3>
<p>The filter expressions in <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause may be pushed down to OpenSearch DSL queries to avoid large amounts of data retrieved. In this case, for OpenSearch multi-field (a text field with another keyword field inside), assumption is made that the keyword field name is always “keyword” which is true by default.</p>
</section>
<section id="multiple-window-functions">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Multiple Window Functions</a><a class="headerlink" href="#multiple-window-functions" title="Link to this heading">¶</a></h3>
<p>At the moment there is no optimization to merge similar sort operators to avoid unnecessary sort. In this case, only one sort operator associated with window function will be pushed down to OpenSearch DSL queries. Others will sort the intermediate results in memory and return to its window operator in the upstream. This cost can be avoided by optimization aforementioned though in-memory sorting operation can still happen. Therefore a custom circuit breaker is in use to monitor sort operator and protect memory usage.</p>
</section>
<section id="sort-push-down">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Sort Push Down</a><a class="headerlink" href="#sort-push-down" title="Link to this heading">¶</a></h3>
<p>Without sort push down optimization, the sort operator will sort the result from child operator. By default, only 200 docs will extracted from the source index, <a class="reference external" href="../admin/settings.rst#opensearch-query-size-limit">you can change this value by using size_limit setting</a>.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Example</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;workshop participant.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../_sources/user/optimization/optimization.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>